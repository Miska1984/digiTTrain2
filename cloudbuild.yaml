# Cloud Build beÃ¡llÃ­tÃ¡sok
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: E2_HIGHCPU_8
  diskSizeGb: 20
  substitution_option: ALLOW_LOOSE

steps:
  # 0ï¸âƒ£ LÃ©trehozzuk az .env.yaml fÃ¡jlt a kÃ¶rnyezeti vÃ¡ltozÃ³kkal + CORS konfigurÃ¡ciÃ³
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - -c
      - |
        # Hardcoded .env.yaml generÃ¡lÃ¡s
        cat > .env.yaml <<'ENVEOF'
        DB_NAME: digittraindb
        DB_USER: root
        DB_PASS: MIshek001-1984
        DJANGO_SETTINGS_MODULE: digiTTrain.settings
        ALLOWED_HOSTS: digit-train-web-195803356854.europe-west1.run.app,digit-train.hu,www.digit-train.hu
        CLOUDSQL_CONNECTION_NAME: digittrain-projekt:europe-west1:digitrain-mysql-db-west1
        GS_BUCKET_NAME: digittrain-media-publikus-miska1984
        GS_PROJECT_ID: digittrain-projekt
        GS_LOCATION: europe-west1
        ENVIRONMENT: production
        GCP_SA_KEY_PATH: /app/gcp_service_account.json
        REDIS_HOST: 10.32.84.131
        REDIS_PORT: "6379"
        ENVEOF
        
        echo "âœ… .env.yaml lÃ©trehozva:"
        cat .env.yaml
        
        # CORS konfigurÃ¡ciÃ³
        echo "ðŸŒ CORS konfigurÃ¡ciÃ³ alkalmazÃ¡sa..."
        gsutil cors set cors-config.json gs://digittrain-media-publikus-miska1984
        gsutil cors get gs://digittrain-media-publikus-miska1984

  # 1ï¸âƒ£ LetÃ¶ltjÃ¼k a GCP kulcsot a Cloud Storage-bÅ‘l
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - '-c'
      - >
        echo "ðŸ”‘ GCP service account kulcs letÃ¶ltÃ©se...";
        gsutil cp gs://digittrain-secrets/gcp_service_account.json ./gcp_service_account.json;
        ls -l ./gcp_service_account.json

  # 2ï¸âƒ£ Docker image build - Web Service
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'europe-west1-docker.pkg.dev/digittrain-projekt/digittrain-web/app:latest', '.']

  # 3ï¸âƒ£ Docker image push - Web Service
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'europe-west1-docker.pkg.dev/digittrain-projekt/digittrain-web/app:latest']

  # 4ï¸âƒ£ Docker image build - Celery Worker
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-f', 'Dockerfile.worker', '-t', 'europe-west1-docker.pkg.dev/digittrain-projekt/digittrain-web/celery-worker:latest', '.']

  # 5ï¸âƒ£ Docker image push - Celery Worker
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'europe-west1-docker.pkg.dev/digittrain-projekt/digittrain-web/celery-worker:latest']

  # 6ï¸âƒ£ MigrÃ¡ciÃ³ futtatÃ¡sa
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - -c
      - |
        gcloud run jobs update migrate-job \
          --image europe-west1-docker.pkg.dev/digittrain-projekt/digittrain-web/app:latest \
          --region europe-west1 \
          --command "python" \
          --args "manage.py","migrate","--verbosity","3" \
          --env-vars-file .env.yaml \
          --set-cloudsql-instances digittrain-projekt:europe-west1:digitrain-mysql-db-west1 \
        || gcloud run jobs create migrate-job \
          --image europe-west1-docker.pkg.dev/digittrain-projekt/digittrain-web/app:latest \
          --region europe-west1 \
          --command "python" \
          --args "manage.py","migrate","--verbosity","3" \
          --env-vars-file .env.yaml \
          --set-cloudsql-instances digittrain-projekt:europe-west1:digitrain-mysql-db-west1
        
        echo "ðŸ”„ MigrÃ¡ciÃ³ futtatÃ¡sa..."
        gcloud run jobs execute migrate-job --region=europe-west1 --wait

  # 7ï¸âƒ£ Initial data job futtatÃ¡sa
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - -c
      - |
        echo "ðŸ“¦ Initial data job futtatÃ¡sa..."
        gcloud run jobs execute initial-data-job --region=europe-west1 --wait || echo "âš ï¸ Initial data job mÃ¡r futott vagy nem lÃ©tezik"

  # 8ï¸âƒ£ Deploy Web Service (VPC Connector-ral)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - run
      - deploy
      - digit-train-web
      - --image
      - europe-west1-docker.pkg.dev/digittrain-projekt/digittrain-web/app:latest
      - --region
      - europe-west1
      - --platform
      - managed
      - --allow-unauthenticated
      - --env-vars-file
      - .env.yaml
      - --add-cloudsql-instances
      - digittrain-projekt:europe-west1:digitrain-mysql-db-west1
      - --vpc-connector
      - redis-connector
      - --vpc-egress
      - private-ranges-only
      - --min-instances
      - '0'
      - --max-instances
      - '10'
      - --memory
      - 2Gi
      - --cpu
      - '2'
      - --timeout
      - 300s

  # 9ï¸âƒ£ Celery Worker Job lÃ©trehozÃ¡sa vagy frissÃ­tÃ©se
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
    - -c
    - |
      echo "ðŸš€ Celery worker job lÃ©trehozÃ¡sa vagy frissÃ­tÃ©se..."
      set -e
      if gcloud run jobs describe celery-worker-job --region europe-west1 --project digittrain-projekt > /dev/null 2>&1; then
        gcloud run jobs update celery-worker-job \
          --image europe-west1-docker.pkg.dev/digittrain-projekt/digittrain-web/celery-worker:latest \
          --region europe-west1 \
          --platform managed \
          --no-allow-unauthenticated \
          --env-vars-file .env.yaml \
          --add-cloudsql-instances digittrain-projekt:europe-west1:digitrain-mysql-db-west1 \
          --vpc-connector redis-connector \
          --vpc-egress private-ranges-only \
          --memory 2Gi \
          --cpu 2 \
          --timeout 900s \
          --execution-environment gen2 \
          --command celery \
          --args -A digiTTrain worker --loglevel=info --concurrency=2 --pool=solo
      else
        gcloud run jobs create celery-worker-job \
          --image europe-west1-docker.pkg.dev/digittrain-projekt/digittrain-web/celery-worker:latest \
          --region europe-west1 \
          --platform managed \
          --no-allow-unauthenticated \
          --env-vars-file .env.yaml \
          --add-cloudsql-instances digittrain-projekt:europe-west1:digitrain-mysql-db-west1 \
          --vpc-connector redis-connector \
          --vpc-egress private-ranges-only \
          --memory 2Gi \
          --cpu 2 \
          --timeout 900s \
          --execution-environment gen2 \
          --command celery \
          --args -A digiTTrain worker --loglevel=info --concurrency=2 --pool=solo
      fi

      echo "ðŸŽ¯ Teszt futÃ¡s (elsÅ‘ prÃ³ba)..."
      gcloud run jobs execute celery-worker-job \
        --region europe-west1 --project digittrain-projekt --wait

timeout: 3600s

options:
  logging: CLOUD_LOGGING_ONLY