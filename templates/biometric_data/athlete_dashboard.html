{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-primary text-white" style="border-radius: 20px; background: linear-gradient(135deg, #0d6efd 0%, #003d99 100%);">
                <div class="card-body p-4 d-flex align-items-center">
                    <div class="flex-shrink-0 bg-white rounded-circle p-2 me-4 shadow-lg">
                        <i class="bi bi-robot text-primary fs-1"></i>
                    </div>
                    <div>
                        <h4 class="fw-bold mb-1">Ditta 30 napos elemzése</h4>
                        <p class="mb-0 italic opacity-90">{{ welcome_message }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-5 text-center">
        <div class="col-6 col-md-3">
            <a href="{% url 'biometric_data:morning_check' %}" class="btn btn-outline-primary w-100 p-3 shadow-sm rounded-4">
                <i class="bi bi-sun fs-3 d-block mb-2"></i> Reggeli mérés
            </a>
        </div>
        <div class="col-6 col-md-3">
            <a href="{% url 'biometric_data:after_training' %}" class="btn btn-outline-success w-100 p-3 shadow-sm rounded-4">
                <i class="bi bi-droplet-half fs-3 d-block mb-2"></i> Edzés utáni
            </a>
        </div>
        <div class="col-6 col-md-3">
            <a href="{% url 'biometric_data:add_running_performance' %}" class="btn btn-outline-info w-100 p-3 shadow-sm rounded-4">
                <i class="bi bi-speedometer2 fs-3 d-block mb-2"></i> Futás rögzítése
            </a>
        </div>
        <div class="col-6 col-md-3">
            <a href="{% url 'biometric_data:occasional_measurements' %}" class="btn btn-outline-warning w-100 p-3 shadow-sm rounded-4">
                <i class="bi bi-calendar-event fs-3 d-block mb-2"></i> Eseti (Testzsír)
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card h-100 shadow border-0 rounded-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">Súlykontroll Trend</h5>
                        <button class="btn btn-sm btn-light rounded-pill" data-bs-toggle="collapse" data-bs-target="#weightInsight">
                            <i class="bi bi-magic me-1"></i> Ditta elemzése
                        </button>
                    </div>
                    <div class="collapse mb-3" id="weightInsight">
                        <div class="p-3 bg-light rounded-3 small border-start border-primary border-4">
                            {{ weight_feedback|safe }}
                        </div>
                    </div>
                    <canvas id="weightChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card h-100 shadow border-0 rounded-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">Regeneráció (HRV)</h5>
                        <button class="btn btn-sm btn-light rounded-pill" data-bs-toggle="collapse" data-bs-target="#hrvInsight">
                            <i class="bi bi-magic me-1"></i> Ditta elemzése
                        </button>
                    </div>
                    <div class="collapse mb-3" id="hrvInsight">
                        <div class="p-3 bg-light rounded-3 small border-start border-success border-4">
                            {{ hrv_sleep_feedback|safe }}
                        </div>
                    </div>
                    <canvas id="hrvSleepChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<script>
    // 1. UNIVERZÁLIS FIX: Megakadályozzuk a szöveg eltűnését az összes lenyíló fülben
    document.addEventListener('DOMContentLoaded', function() {
        // Megkeressük az összes collapse elemet (weightInsight, hrvInsight, stb.)
        var collapsibles = document.querySelectorAll('.collapse');
        
        collapsibles.forEach(function(el) {
            // Amikor a kinyílás befejeződött
            el.addEventListener('shown.bs.collapse', function () {
                this.style.height = 'auto';
                this.style.display = 'block';
                this.style.visibility = 'visible';
                this.style.opacity = '1';
                console.log('Ditta elemzése fixálva: ' + this.id);
            });
        });
    });

    // 2. SEGÉDFÜGGVÉNY: Csak akkor rajzolunk, ha létezik az elem és van adat
    function safeRenderChart(canvasId, chartData, configGenerator) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return; 

        if (chartData && chartData.labels && chartData.labels.length > 0) {
            const ctx = canvas.getContext('2d');
            new Chart(ctx, configGenerator(chartData));
        } else {
            canvas.parentNode.innerHTML = '<p class="text-center text-muted my-4">Nincs elegendő adat a grafikon megjelenítéséhez.</p>';
        }
    }

    // 3. ADATOK ELŐKÉSZÍTÉSE
    const parseData = (jsonStr) => {
        try {
            return JSON.parse(jsonStr.replace(/&quot;/g, '"'));
        } catch (e) {
            return null;
        }
    };

    const weightChartData = parseData('{{ weight_chart_data_json|default:"{}"|safe }}');
    const hrvSleepChartData = parseData('{{ hrv_sleep_chart_data_json|default:"{}"|safe }}');
    const gripIntensityChartData = parseData('{{ grip_intensity_chart_data_json|default:"{}"|safe }}');
    const runningChartData = parseData('{{ running_chart_data_json|default:"{}"|safe }}');

    // 4. GRAFIKONOK RENDERELÉSE
    
    // Súlykontroll
    safeRenderChart('weightChart', weightChartData, (data) => ({
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [
                { label: 'Súly (kg)', data: data.weights, borderColor: '#0d6efd', tension: 0.2, yAxisID: 'y' },
                { label: 'Testzsír (%)', data: data.body_fat_data, borderColor: '#dc3545', tension: 0.2, yAxisID: 'y2' }
            ]
        },
        options: { 
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { position: 'left' }, y2: { position: 'right', grid: { drawOnChartArea: false } } } 
        }
    }));

    // HRV & Alvás
    safeRenderChart('hrvSleepChart', hrvSleepChartData, (data) => ({
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [
                { label: 'HRV (ms)', data: data.hrv_data, borderColor: '#198754', fill: true, backgroundColor: 'rgba(25, 135, 84, 0.1)', tension: 0.3 },
                { label: 'Alvás (1-10)', data: data.sleep_quality_data, type: 'bar', backgroundColor: '#6c757d', yAxisID: 'y2' }
            ]
        },
        options: { 
            responsive: true,
            maintainAspectRatio: false,
            scales: { y2: { position: 'right', min: 0, max: 10, grid: { drawOnChartArea: false } } } 
        }
    }));

    // Marokerő és Futás (hasonlóan, ha lesz canvas-uk)
</script>

<style>
    /* CSS biztonsági mentés: ha a JS késne, a kinyitott állapotot kényszerítjük */
    .collapse.show {
        display: block !important;
        height: auto !important;
        opacity: 1 !important;
        visibility: visible !important;
    }
</style>
{% endblock %}