{% extends "base.html" %}
{% load i18n %}


{% block content %}
<div class="container mx-auto my-10 max-w-4xl p-6 bg-white rounded-lg shadow-md">
    <h1 class="text-2xl font-bold mb-6 text-center">Testsúly és testösszetétel adatok</h1>
    
    <!-- Gomb az adatok hozzáadásához -->
    <div class="flex justify-center mb-6">
        <a href="{% url 'biometric_data:add_weight' %}" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-300">
            Új adat hozzáadása
        </a>
    </div>

    <div class="w-full h-96">
        <canvas id="weightChart"></canvas>
    </div>

    <div class="mt-8 overflow-x-auto">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Adatok listája</h2>
        {% if table_data %}
        <table class="min-w-full divide-y divide-gray-200 shadow overflow-hidden rounded-lg">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Dátum
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Reggeli Súly (kg)
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Edzés Előtti Súly (kg)
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Edzés Utáni Súly (kg)
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Folyadékbevitel (l)
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Testzsír (kg)
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Izom (kg)
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Csonttömeg (kg)
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for entry in table_data %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {{ entry.workout_date|date:"Y-m-d" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ entry.morning_weight }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ entry.pre_workout_weight|default_if_none:"N/A" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ entry.post_workout_weight|default_if_none:"N/A" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ entry.fluid_intake|default_if_none:"N/A" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ entry.fat_kg|floatformat:2|default_if_none:"N/A" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ entry.muscle_kg|floatformat:2|default_if_none:"N/A" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ entry.bone_mass_kg|default_if_none:"N/A" }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-center text-gray-500">Még nincs rögzített testsúlyadatod.</p>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // A DOM tartalmának betöltése után futtatjuk a szkriptet
    document.addEventListener('DOMContentLoaded', function() {
        // Django template tag-ekkel beillesztett JSON adatok
        const chartDataJson = JSON.parse('{{ chart_data_json|escapejs }}');
        
        // Előkészítjük a testzsír és izom adatokat, hogy a grafikon kezelni tudja a null értékeket
        const bodyFatData = chartDataJson.body_fat_data.map(item => item.y);
        const muscleData = chartDataJson.muscle_data.map(item => item.y);

        // Canvas elem kiválasztása
        const ctx = document.getElementById('weightChart').getContext('2d');

        // Grafikon létrehozása
        const weightChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartDataJson.labels,
                datasets: [
                    {
                        label: 'Reggeli testsúly (kg)',
                        data: chartDataJson.weights,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Testzsír (kg)',
                        data: bodyFatData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        yAxisID: 'y1'
                    },
                    {
                        label: 'Izomtömeg (kg)',
                        data: muscleData,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Dátum'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Súly (kg)',
                            color: 'rgb(75, 192, 192)'
                        },
                        position: 'left',
                        beginAtZero: false,
                    },
                    y1: {
                        title: {
                            display: true,
                            text: 'Tömeg (kg)',
                            color: 'rgb(255, 99, 132)'
                        },
                        position: 'right',
                        beginAtZero: false,
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            // Egyedi tooltip, ami mutatja a testzsír és izom %-át is
                            label: function(context) {
                                const datasetLabel = context.dataset.label || '';
                                const rawIndex = context.dataIndex;
                                const rawValue = context.raw;
                                
                                // A view-ból érkező adatok használata a pontos értékekhez
                                let displayValue = `${rawValue} kg`;
                                if (datasetLabel === 'Testzsír (kg)') {
                                    const percentage = chartDataJson.body_fat_data[rawIndex].p;
                                    displayValue = percentage !== null ? `${rawValue} kg (${percentage}%)` : 'N/A';
                                } else if (datasetLabel === 'Izomtömeg (kg)') {
                                    const percentage = chartDataJson.muscle_data[rawIndex].p;
                                    displayValue = percentage !== null ? `${rawValue} kg (${percentage}%)` : 'N/A';
                                }
                                
                                return `${datasetLabel}: ${displayValue}`;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
