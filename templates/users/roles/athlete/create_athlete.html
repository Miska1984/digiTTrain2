{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>Sportol√≥ szerepk√∂r ig√©nyl√©se</h2>
    <form method="post" id="athlete-form">
         {% if form.errors %}
            <div class="alert alert-danger">
                <strong>Hiba a bek√ºld√©sn√©l:</strong>
                <ul>
                    {% for field, errors in form.errors.items %}
                        <li>{{ field }}: {{ errors|join:", " }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        {% csrf_token %}
        <div class="mb-3">
            <label for="id_club" class="form-label">Egyes√ºlet</label>
            {{ form.club }}
        </div>
        <div class="mb-3">
            <label for="id_sport" class="form-label">Sport√°g</label>
            {{ form.sport }}
        </div>
        <div class="mb-3">
            <label for="id_coach" class="form-label">Edz≈ë</label>
            {{ form.coach }}
        </div>
        <div class="mb-3" id="parent-field" {% if not kiskoru %}style="display: none;"{% endif %}>
            <label for="id_parent" class="form-label">Sz√ºl≈ë</label>
            {{ form.parent }}
        </div>
        <div class="mb-3">
            <label for="id_notes" class="form-label">Megjegyz√©s</label>
            {{ form.notes }}
        </div>
        <button type="submit" class="btn btn-primary">Bek√ºld√©s</button>
    </form>
</div>


{% endblock %}



{% block extra_js %}

<script>

function isHtmlResponse(data, jqXHR) {
    const ct = jqXHR.getResponseHeader("Content-Type") || "";
    return (typeof data === "string" && ct.includes("text/html"));
}

$(document).ready(function () {
    console.log("üß† √öj Athlete JS bet√∂ltve.");

    const isUnderage = "{{ kiskoru|yesno:'true,false' }}" === "true";
    const initialClub = $("#id_club").val();
    const initialSport = $("#id_sport").val();
    const initialCoach = $("#id_coach").val();
    const initialParent = $("#id_parent").val();

    if (!isUnderage) {
        $("#parent-field").hide();
    }

    // ---------------------------------------------------------
    // üîß Helper f√ºggv√©ny: csak akkor futtatja a callback-et,
    // ha a v√°lasz LISTA. Ha nem ‚Üí logol √©s le√°ll.
    // ---------------------------------------------------------
    function handleListResponse(data, onSuccess) {
        if (!Array.isArray(data)) {
            console.error("‚ùå Hib√°s v√°lasz, nem lista:", data);
            return;
        }
        onSuccess(data);
    }

    // ---------------------------------------------------------
    // üîµ SPORTOK BET√ñLT√âSE
    // ---------------------------------------------------------
    function loadSports(clubId, initialSport = null, initialCoach = null, initialParent = null) {
        $("#id_sport").empty().append('<option value="">V√°lassz sport√°gat</option>');
        $("#id_coach").empty().append('<option value="">V√°lassz edz≈ët</option>');
        $("#id_parent").empty().append('<option value="">V√°lassz sz√ºl≈ët</option>');
        
        if (!clubId) return;

        $.get("{% url 'users:get_sports_by_club' %}", { club_id: clubId })
        .done(function(data, status, jqXHR) {

            // üö® HTML v√°lasz ellen≈ërz√©se
            if (isHtmlResponse(data, jqXHR)) {
                console.error("üö® HTML √©rkezett JSON helyett (loadSports) ‚Üí interstitial val√≥sz√≠n≈±!\n", data.slice(0,150));
                return;
            }

            // üö® JSON t√∂mb ellen≈ërz√©se
            if (!Array.isArray(data)) {
                console.error("‚ùå Hib√°s JSON (nem lista):", data);
                return;
            }

            // --- √âRV√âNYES V√ÅLASZ ---
            let sportSelect = $("#id_sport");
            data.forEach(item => sportSelect.append(`<option value="${item.id}">${item.name}</option>`));

            if (initialSport) sportSelect.val(initialSport);

            if (sportSelect.val()) {
                loadCoaches(clubId, sportSelect.val(), initialCoach, initialParent);
            }
        })
        .fail(function(xhr, status, error) {
            console.error("AJAX HIBA (loadSports):", xhr.status, xhr.responseText);
        });
    }



    // ---------------------------------------------------------
    // üîµ EDZ≈êK BET√ñLT√âSE
    // ---------------------------------------------------------
    function loadCoaches(clubId, sportId, initialCoach = null, initialParent = null) {
        $("#id_coach").empty().append('<option value="">V√°lassz edz≈ët</option>');
        $("#id_parent").empty().append('<option value="">V√°lassz sz√ºl≈ët</option>');

        if (!clubId || !sportId) return;

        $.get("{% url 'users:get_coaches_by_club_and_sport' %}", { club_id: clubId, sport_id: sportId })
        .done(function(data, status, jqXHR) {

            if (isHtmlResponse(data, jqXHR)) {
                console.error("üö® HTML √©rkezett JSON helyett (loadCoaches)!\n", data.slice(0,150));
                return;
            }

            if (!Array.isArray(data)) {
                console.error("‚ùå Hib√°s JSON (nem lista):", data);
                return;
            }

            let coachSelect = $("#id_coach");
            data.forEach(item => coachSelect.append(`<option value="${item.id}">${item.name}</option>`));

            if (initialCoach) coachSelect.val(initialCoach);

            if (coachSelect.val()) {
                loadParents(clubId, sportId, coachSelect.val(), initialParent);
            }
        })
        .fail(function(xhr) {
            console.error("AJAX HIBA (loadCoaches):", xhr.status, xhr.responseText);
        });
    }



    // ---------------------------------------------------------
    // üîµ SZ√úL≈êK BET√ñLT√âSE (csak kiskor√∫n√°l)
    // ---------------------------------------------------------
    function loadParents(clubId, sportId, coachId, initialParent = null) {
        $("#id_parent").empty().append('<option value="">V√°lassz sz√ºl≈ët</option>');

        if (!isUnderage) {
            $("#parent-field").hide();
            return;
        }

        $("#parent-field").show();

        if (!clubId || !sportId || !coachId) return;

        $.get("{% url 'users:get_parents_by_club_sport_and_coach' %}", {
            club_id: clubId, sport_id: sportId, coach_id: coachId
        })
        .done(function(data, status, jqXHR) {

            if (isHtmlResponse(data, jqXHR)) {
                console.error("üö® HTML √©rkezett JSON helyett (loadParents)!\n", data.slice(0,150));
                return;
            }

            if (!Array.isArray(data)) {
                console.error("‚ùå Hib√°s JSON (nem lista):", data);
                return;
            }

            let parentSelect = $("#id_parent");
            data.forEach(item => parentSelect.append(`<option value="${item.id}">${item.name}</option>`));

            if (initialParent) parentSelect.val(initialParent);
        })
        .fail(function(xhr) {
            console.error("AJAX HIBA (loadParents):", xhr.status, xhr.responseText);
        });
    }


    // ---------------------------------------------------------
    // üîÑ EVENT LISTENEREK
    // ---------------------------------------------------------
    $("#id_club").change(function () {
        loadSports($(this).val());
    });

    $("#id_sport").change(function () {
        loadCoaches($("#id_club").val(), $(this).val());
    });

    $("#id_coach").change(function () {
        loadParents($("#id_club").val(), $("#id_sport").val(), $(this).val());
    });

    // ---------------------------------------------------------
    // ‚ôªÔ∏è √öJRAT√ñLT√âS UT√ÅNI AUTOMATIKUS BET√ñLT√âS
    // ---------------------------------------------------------
    if (initialClub) {
        loadSports(initialClub, initialSport, initialCoach, initialParent);
    }
});
</script>


{% endblock %}