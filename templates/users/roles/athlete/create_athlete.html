{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>Sportol√≥ szerepk√∂r ig√©nyl√©se</h2>
    <form method="post" id="athlete-form">
         {% if form.errors %}
            <div class="alert alert-danger">
                <strong>Hiba a bek√ºld√©sn√©l:</strong>
                <ul>
                    {% for field, errors in form.errors.items %}
                        <li>{{ field }}: {{ errors|join:", " }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        {% csrf_token %}
        <div class="mb-3">
            <label for="id_club" class="form-label">Egyes√ºlet</label>
            {{ form.club }}
        </div>
        <div class="mb-3">
            <label for="id_sport" class="form-label">Sport√°g</label>
            {{ form.sport }}
        </div>
        <div class="mb-3">
            <label for="id_coach" class="form-label">Edz≈ë</label>
            {{ form.coach }}
        </div>
        <div class="mb-3" id="parent-field" {% if not kiskoru %}style="display: none;"{% endif %}>
            <label for="id_parent" class="form-label">Sz√ºl≈ë</label>
            {{ form.parent }}
        </div>
        <div class="mb-3">
            <label for="id_notes" class="form-label">Megjegyz√©s</label>
            {{ form.notes }}
        </div>
        <button type="submit" class="btn btn-primary">Bek√ºld√©s</button>
    </form>
</div>


{% endblock %}



{% block extra_js %}

<script>
$(document).ready(function () {
    console.log("üß† √öj Athlete JS bet√∂ltve.");

    const isUnderage = "{{ kiskoru|yesno:'true,false' }}" === "true";
    const initialClub = $("#id_club").val();
    const initialSport = $("#id_sport").val();
    const initialCoach = $("#id_coach").val();
    const initialParent = $("#id_parent").val();

    if (!isUnderage) {
        $("#parent-field").hide();
    }

    // ---------------------------------------------------------
    // üîß Helper f√ºggv√©ny: csak akkor futtatja a callback-et,
    // ha a v√°lasz LISTA. Ha nem ‚Üí logol √©s le√°ll.
    // ---------------------------------------------------------
    function handleListResponse(data, onSuccess) {
        if (!Array.isArray(data)) {
            console.error("‚ùå Hib√°s v√°lasz, nem lista:", data);
            return;
        }
        onSuccess(data);
    }

    // ---------------------------------------------------------
    // üîµ SPORTOK BET√ñLT√âSE
    // ---------------------------------------------------------
    function loadSports(clubId, preselectSport = null, preselectCoach = null, preselectParent = null) {
        $("#id_sport").empty().append('<option value="">V√°lassz sport√°gat</option>');
        $("#id_coach").empty().append('<option value="">V√°lassz edz≈ët</option>');
        $("#id_parent").empty().append('<option value="">V√°lassz sz√ºl≈ët</option>');

        if (!clubId) return;

        $.get("{% url 'users:get_sports_by_club' %}", { club_id: clubId })
            .done(function (data) {
                handleListResponse(data, function (list) {
                    const select = $("#id_sport");
                    list.forEach(i => select.append(`<option value="${i.id}">${i.name}</option>`));

                    if (preselectSport) select.val(preselectSport);

                    if (select.val()) {
                        loadCoaches(clubId, select.val(), preselectCoach, preselectParent);
                    }
                });
            })
            .fail(function (xhr) {
                console.error("‚ùå Hiba sportok bet√∂lt√©sekor:", xhr.responseText);
            });
    }

    // ---------------------------------------------------------
    // üîµ EDZ≈êK BET√ñLT√âSE
    // ---------------------------------------------------------
    function loadCoaches(clubId, sportId, preselectCoach = null, preselectParent = null) {
        $("#id_coach").empty().append('<option value="">V√°lassz edz≈ët</option>');
        $("#id_parent").empty().append('<option value="">V√°lassz sz√ºl≈ët</option>');

        if (!clubId || !sportId) return;

        $.get("{% url 'users:get_coaches_by_club_and_sport' %}", {
            club_id: clubId,
            sport_id: sportId
        })
            .done(function (data) {
                handleListResponse(data, function (list) {
                    const select = $("#id_coach");
                    list.forEach(i =>
                        select.append(`<option value="${i.id}">${i.name}</option>`)
                    );

                    if (preselectCoach) select.val(preselectCoach);

                    if (select.val()) {
                        loadParents(clubId, sportId, select.val(), preselectParent);
                    }
                });
            })
            .fail(function (xhr) {
                console.error("‚ùå Hiba edz≈ëk bet√∂lt√©sekor:", xhr.responseText);
            });
    }

    // ---------------------------------------------------------
    // üîµ SZ√úL≈êK BET√ñLT√âSE (csak kiskor√∫n√°l)
    // ---------------------------------------------------------
    function loadParents(clubId, sportId, coachId, preselectParent = null) {
        $("#id_parent").empty().append('<option value="">V√°lassz sz√ºl≈ët</option>');

        if (!isUnderage) {
            $("#parent-field").hide();
            return;
        }

        $("#parent-field").show();

        if (!clubId || !sportId || !coachId) return;

        $.get("{% url 'users:get_parents_by_club_sport_and_coach' %}", {
            club_id: clubId,
            sport_id: sportId,
            coach_id: coachId
        })
            .done(function (data) {
                handleListResponse(data, function (list) {
                    const select = $("#id_parent");
                    list.forEach(i =>
                        select.append(`<option value="${i.id}">${i.name}</option>`)
                    );

                    if (preselectParent) select.val(preselectParent);
                });
            })
            .fail(function (xhr) {
                console.error("‚ùå Hiba sz√ºl≈ëk bet√∂lt√©sekor:", xhr.responseText);
            });
    }

    // ---------------------------------------------------------
    // üîÑ EVENT LISTENEREK
    // ---------------------------------------------------------
    $("#id_club").change(function () {
        loadSports($(this).val());
    });

    $("#id_sport").change(function () {
        loadCoaches($("#id_club").val(), $(this).val());
    });

    $("#id_coach").change(function () {
        loadParents($("#id_club").val(), $("#id_sport").val(), $(this).val());
    });

    // ---------------------------------------------------------
    // ‚ôªÔ∏è √öJRAT√ñLT√âS UT√ÅNI AUTOMATIKUS BET√ñLT√âS
    // ---------------------------------------------------------
    if (initialClub) {
        loadSports(initialClub, initialSport, initialCoach, initialParent);
    }
});
</script>


{% endblock %}