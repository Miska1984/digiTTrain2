{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>Sportol√≥ szerepk√∂r ig√©nyl√©se</h2>
    <form method="post" id="athlete-form">
         {% if form.errors %}
            <div class="alert alert-danger">
                <strong>Hiba a bek√ºld√©sn√©l:</strong>
                <ul>
                    {% for field, errors in form.errors.items %}
                        <li>{{ field }}: {{ errors|join:", " }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        {% csrf_token %}
        <div class="mb-3">
            <label for="id_club" class="form-label">Egyes√ºlet</label>
            {{ form.club }}
        </div>
        <div class="mb-3">
            <label for="id_sport" class="form-label">Sport√°g</label>
            {{ form.sport }}
        </div>
        <div class="mb-3">
            <label for="id_coach" class="form-label">Edz≈ë</label>
            {{ form.coach }}
        </div>
        <div class="mb-3" id="parent-field" {% if not kiskoru %}style="display: none;"{% endif %}>
            <label for="id_parent" class="form-label">Sz√ºl≈ë</label>
            {{ form.parent }}
        </div>
        <div class="mb-3">
            <label for="id_notes" class="form-label">Megjegyz√©s</label>
            {{ form.notes }}
        </div>
        <button type="submit" class="btn btn-primary">Bek√ºld√©s</button>
    </form>
</div>


{% endblock %}



{% block extra_js %}

<script>
$(document).ready(function() {
    console.log("üß© JS inicializ√°lva (athlete page).");

    // Ezzel logoljuk, hogy mikor melyik AJAX k√©r√©s indul
    $(document).ajaxSend(function(event, xhr, settings) {
        console.log("‚û°Ô∏è AJAX INDULT:", settings.url, " PARAMS:", settings.data);
    });

    // √âs ha b√°rmelyik hib√°t dob:
    $(document).ajaxError(function(event, xhr, settings, thrownError) {
        console.error("üí• AJAX HIBA!", settings.url, "STATUS:", xhr.status, "RESPONSE:", xhr.responseText);
    });
});

$(document).ready(function(){
    // Kezdeti √©rt√©kek ment√©se, hogy az ≈±rlap √∫jrat√∂lt√©sekor vissza√°lljanak (valid√°ci√≥s hiba eset√©n)
    const isUnderage = "{{ kiskoru|yesno:'true,false' }}" === "true";
    const initialClubId = $("#id_club").val();
    const initialSportId = $("#id_sport").val();
    const initialCoachId = $("#id_coach").val();
    const initialParentId = $("#id_parent").val(); 
    
    // Kezdetben elrejtj√ºk a sz√ºl≈ë mez≈ët, ha a felhaszn√°l√≥ nagykor√∫
    if (!isUnderage) {
        $("#parent-field").hide();
    }

    // -------------------------------------------------------------
    // F√úGGV√âNYEK: AZ ADATOK ASZINKRON BET√ñLT√âS√âRE
    // -------------------------------------------------------------

    function loadSports(clubId, initialSport = null, initialCoach = null, initialParent = null) {
        $("#id_sport").empty().append('<option value="">V√°lassz sport√°gat</option>');
        $("#id_coach").empty().append('<option value="">V√°lassz edz≈ët</option>');
        $("#id_parent").empty().append('<option value="">V√°lassz sz√ºl≈ët</option>');
        
        // ‚ùå A kritikus pont: Ha a Club ID hi√°nyzik, azonnal visszat√©r√ºnk
        if (!clubId) { 
            console.log("‚ùå loadSports le√°llt: Nincs Club ID.");
            return;
        }

        console.log(`‚úÖ loadSports indult Club ID: ${clubId}`);

        $.get("{% url 'users:get_sports_by_club' %}", {club_id: clubId}, function(data){
            let sportSelect = $("#id_sport");
            data.forEach(function(item){
                sportSelect.append(`<option value="${item.id}">${item.name}</option>`);
            });
            
            if (initialSport) {
                sportSelect.val(initialSport);
            }
            
            if (sportSelect.val()) {
                loadCoaches(clubId, sportSelect.val(), initialCoach, initialParent);
            }
        }).fail(function(xhr, status, error) {
            // A saj√°t AJAX k√©r√©s√ºnk hib√°ja! Ha itt 400-at l√°t, a Django adta vissza.
            console.error("AJAX HIBA: Hiba a sport√°gak bet√∂lt√©sekor. Status:", xhr.status, "Error:", error, "V√°lasz:", xhr.responseText);
        });
    }

    function loadCoaches(clubId, sportId, initialCoach = null, initialParent = null) {
        $("#id_coach").empty().append('<option value="">V√°lassz edz≈ët</option>');
        $("#id_parent").empty().append('<option value="">V√°lassz sz√ºl≈ët</option>');
        if (!clubId || !sportId) { return; }
        
        console.log(`‚úÖ loadCoaches indult Club ID: ${clubId}, Sport ID: ${sportId}`);
        
        $.get("{% url 'users:get_coaches_by_club_and_sport' %}", {club_id: clubId, sport_id: sportId}, function(data){
            let coachSelect = $("#id_coach");
            data.forEach(function(item){
                coachSelect.append(`<option value="${item.id}">${item.name}</option>`);
            });
            if (initialCoach) { coachSelect.val(initialCoach); }
            if (coachSelect.val()) { loadParents(clubId, sportId, coachSelect.val(), initialParent); }
        }).fail(function(xhr, status, error) {
            console.error("AJAX HIBA: Hiba az edz≈ëk bet√∂lt√©sekor. Status:", xhr.status, "Error:", error, "V√°lasz:", xhr.responseText);
        });
    }

    function loadParents(clubId, sportId, coachId, initialParent = null) {
        $("#id_parent").empty().append('<option value="">V√°lassz sz√ºl≈ët</option>');
        if(isUnderage) {
            $("#parent-field").show();
            if (!clubId || !sportId || !coachId) { return; }
            
            console.log(`‚úÖ loadParents indult Club ID: ${clubId}, Sport ID: ${sportId}, Coach ID: ${coachId}`);
            
            $.get("{% url 'users:get_parents_by_club_sport_and_coach' %}", {
                club_id: clubId, sport_id: sportId, coach_id: coachId
            }, function(data){
                let parentSelect = $("#id_parent");
                data.forEach(function(item){
                    parentSelect.append(`<option value="${item.id}">${item.name}</option>`);
                });
                if (initialParent) { parentSelect.val(initialParent); }
            }).fail(function(xhr, status, error) {
                console.error("AJAX HIBA: Hiba a sz√ºl≈ëk bet√∂lt√©sekor. Status:", xhr.status, "Error:", error, "V√°lasz:", xhr.responseText);
            });
        } else {
            $("#parent-field").hide();
        }
    }


    // -------------------------------------------------------------
    // EVENT LISTENEREK
    // -------------------------------------------------------------
    
    $("#id_club").change(function(){
        let selectedClubId = $(this).val(); 
        // üéØ DEBUG KULCSL√âP√âS: Ellen≈ërizze ezt a sort a b√∂ng√©sz≈ë konzolban!
        console.log("Club Change Event: Selected Club ID:", selectedClubId); 
        loadSports(selectedClubId);
    });

    $("#id_sport").change(function(){
        let clubId = $("#id_club").val();
        loadCoaches(clubId, $(this).val());
    });

    $("#id_coach").change(function(){
        let clubId = $("#id_club").val();
        let sportId = $("#id_sport").val();
        loadParents(clubId, sportId, $(this).val());
    });
    
    // -------------------------------------------------------------
    // KEZDETI √ÅLLAPOT IND√çT√ÅSA
    // -------------------------------------------------------------

    if (initialClubId) {
        console.log("‚ÑπÔ∏è Kezdeti l√°nc ind√≠t√°sa (√∫jrat√∂lt√©s) miatt.");
        loadSports(initialClubId, initialSportId, initialCoachId, initialParentId);
    }
});
</script>

{% endblock %}