{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block title %}P√©nz√ºgyi Vez√©rl≈ëpult{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">
        <i class="bi bi-wallet2 me-2"></i> P√©nz√ºgyi Vez√©rl≈ëpult
    </h1>

    <p class="text-gray-600 mb-8">
        Itt tekintheti meg az elemz√©si egyenleg√©t, az el≈ëfizet√©si st√°tuszt, √©s kezelheti a v√°s√°rl√°sokat.
    </p>

    {# ------------------ √ñSSZEFOGLAL√ì K√ÅRTY√ÅK ------------------ #}
    <div class="row row-cols-1 row-cols-md-3 g-4 mb-6">

        {# 1. ELEMZ√âSI EGYENLEG K√ÅRTYA (√öJ!) #}
        <div class="col">
            <div class="card h-100 shadow-sm border-start border-4 border-success">
                <div class="card-body">
                    <h5 class="card-title text-success">
                        <i class="bi bi-graph-up-arrow me-2"></i> Elemz√©si Egyenleg
                    </h5>
                    <p class="display-6 fw-bold mb-0">{{ analysis_balance|intcomma }} db</p>
                    <p class="text-muted">El√©rhet≈ë elemz√©sek sz√°ma</p>
                    
                    <div class="d-flex gap-2">
                        <a href="{% url 'billing:billing_purchase' %}" class="btn btn-sm btn-outline-success">
                            <i class="bi bi-cart-plus-fill me-1"></i> V√°s√°rl√°s
                        </a>
                        <a href="{% url 'billing:ad_credit_earn' %}" class="btn btn-sm btn-outline-info">
                            <i class="bi bi-gift-fill me-1"></i> Ingyenes
                        </a>
                    </div>
                </div>
            </div>
        </div>

        {# 2. EL≈êFIZET√âS ST√ÅTUSZ K√ÅRTYA #}
        <div class="col">
            <div class="card h-100 shadow-sm border-start border-4 {% if current_subscription %}border-primary{% else %}border-warning{% endif %}">
                <div class="card-body">
                    <h5 class="card-title {% if current_subscription %}text-primary{% else %}text-warning{% endif %}">
                        <i class="bi bi-patch-check-fill me-2"></i> El≈ëfizet√©s St√°tusz
                    </h5>
                    {% if current_subscription %}
                        {# AKT√çV HIRDET√âSMENTESS√âG #}
                        <p class="display-6 fw-bold mb-0 text-primary">AKT√çV</p>
                        <p class="text-muted">
                            Csomag: <strong>{{ current_subscription.plan.name }}</strong><br>
                            Lej√°rat: <strong class="text-danger">{{ current_subscription.end_date|date:"Y.m.d H:i" }}</strong>
                        </p>
                        
                        <div class="d-flex gap-2">
                            <a href="{% url 'billing:billing_purchase' %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-arrow-repeat me-1"></i> Meg√∫j√≠t√°s
                            </a>
                        </div>
                    {% else %}
                        {# INAKT√çV HIRDET√âSMENTESS√âG #}
                        <p class="display-6 fw-bold mb-0 text-warning">Inakt√≠v</p>
                        <p class="text-muted">Hirdet√©smentess√©g nincs aktiv√°lva.</p>
                        <a href="{% url 'billing:billing_purchase' %}" class="btn btn-sm btn-warning">
                            <i class="bi bi-lightning-charge-fill me-1"></i> Aktiv√°l√°s
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>

        {# 3. HIRDET√âSN√âZ√âSI SOROZAT K√ÅRTYA (√öJ!) #}
        <div class="col">
            <div class="card h-100 shadow-sm border-start border-4 border-info">
                <div class="card-body">
                    <h5 class="card-title text-info">
                        <i class="bi bi-calendar-check me-2"></i> Hirdet√©sn√©z√©si Sorozat
                    </h5>
                    
                    {% if current_streak > 0 %}
                        <p class="display-6 fw-bold mb-0 text-info">{{ current_streak }}/5 nap</p>
                        <p class="text-muted">M√©g {{ 5|add:"-"|add:current_streak }} nap a jutalmig!</p>
                    {% else %}
                        <p class="display-6 fw-bold mb-0 text-muted">0/5 nap</p>
                        <p class="text-muted">Kezdj el hirdet√©seket n√©zni!</p>
                    {% endif %}
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            √ñsszesen szerzett jutalom: <strong>{{ total_ad_rewards }} db</strong>
                        </small>
                    </div>
                    
                    {% if can_view_ad_today %}
                        <a href="{% url 'billing:ad_credit_earn' %}" class="btn btn-sm btn-info mt-2">
                            <i class="bi bi-play-circle-fill me-1"></i> Hirdet√©s n√©z√©se
                        </a>
                    {% else %}
                        <button class="btn btn-sm btn-secondary mt-2" disabled>
                            <i class="bi bi-check-circle me-1"></i> Ma m√°r n√©ztem
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>


    {# ------------------ LEGUT√ìBBI TRANZAKCI√ìK ------------------ #}
    <h2 class="text-2xl font-semibold mb-4 text-indigo-700 mt-5">Legut√≥bbi Tranzakci√≥k</h2>
    <div class="bg-white shadow rounded-lg p-4">
        <div class="overflow-x-auto">
            <table class="w-full table table-striped border-collapse">
                <thead>
                    <tr class="bg-gray-200 text-left text-sm font-semibold text-gray-700">
                        <th class="p-2 border">Id≈ëpont</th>
                        <th class="p-2 border">T√≠pus</th>
                        <th class="p-2 border text-end">√ñsszeg (db)</th>
                        <th class="p-2 border">Le√≠r√°s</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions %}
                    <tr>
                        <td class="p-2 border">{{ transaction.timestamp|date:"Y.m.d H:i" }}</td>
                        <td class="p-2 border">
                            {% if transaction.transaction_type == 'PURCHASE' %}
                                üí∞ V√°s√°rl√°s
                            {% elif transaction.transaction_type == 'USAGE' %}
                                üìä Felhaszn√°l√°s
                            {% elif transaction.transaction_type == 'AD_REWARD' %}
                                üéÅ Hirdet√©si jutalom
                            {% endif %}
                        </td>
                        <td class="p-2 border text-end fw-bold 
                            {% if transaction.amount > 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if transaction.amount > 0 %}+{% endif %}{{ transaction.amount }} db
                        </td>
                        <td class="p-2 border small">{{ transaction.description|default:"-" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="p-4 text-center text-gray-500">M√©g nincsenek r√∂gz√≠tett tranzakci√≥k.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>
{% endblock content %}