{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block title %}Pénzügyi Vezérlőpult{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">
        <i class="bi bi-wallet2 me-2 text-primary"></i> Pénzügyi Vezérlőpult
    </h1>

    <div class="row row-cols-1 row-cols-md-3 g-4 mb-5">
        {# Elemzési egyenleg #}
        <div class="col">
            <div class="card h-100 shadow-sm border-0 border-start border-4 border-success rounded-4">
                <div class="card-body">
                    <h5 class="card-title text-success d-flex align-items-center">
                        <i class="bi bi-graph-up-arrow me-2 fs-4"></i> Elemzési Egyenleg
                    </h5>
                    <p class="display-6 fw-bold mb-1">{{ analysis_balance }} <small class="fs-4">db</small></p>
                    <p class="text-muted small">Felhasználható mérések</p>
                    <a href="{% url 'billing:billing_purchase' %}" class="btn btn-sm btn-outline-success mt-2 rounded-pill">Vásárlás</a>
                </div>
            </div>
        </div>

        {# Kredit egyenleg #}
        <div class="col">
            <div class="card h-100 shadow-sm border-0 border-start border-4 border-warning rounded-4">
                <div class="card-body">
                    <h5 class="card-title text-warning d-flex align-items-center">
                        <i class="bi bi-coin me-2 fs-4"></i> Aktuális Kreditek
                    </h5>
                    <p class="display-6 fw-bold mb-1">{{ credit_balance }} <small class="fs-4">Cr</small></p>
                    <p class="text-muted small">Beváltható egyenleg</p>
                    {% if ad_earned_today %}
                        <button class="btn btn-sm btn-outline-secondary mt-2 rounded-pill w-100" disabled title="Ma már gyűjtöttél kreditet">
                            <i class="bi bi-check-circle-fill me-1"></i> Kredit begyűjtve
                        </button>
                    {% else %}
                        <a href="{% url 'billing:ad_credit_earn' %}" class="btn btn-sm btn-outline-warning mt-2 rounded-pill w-100 fw-bold">
                            <i class="bi bi-play-circle-fill me-1"></i> Kredit gyűjtése
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Aktív Előfizetések #}
        <div class="col">
            <div class="card h-100 shadow-sm border-0 border-start border-4 border-primary rounded-4">
                <div class="card-body">
                    <h5 class="card-title text-primary d-flex align-items-center">
                        <i class="bi bi-shield-check me-2 fs-4"></i> Aktív Jogosultságok
                    </h5>
                    <ul class="list-unstyled mb-0 mt-2">
                        {% for sub in active_subscriptions %}
                            <li class="mb-2">
                                <span class="badge bg-primary rounded-pill">{{ sub.get_sub_type_display }}</span>
                                <div class="text-muted small mt-1 ps-1">
                                    <i class="bi bi-clock-history"></i> Lejárat: {{ sub.expiry_date|date:"Y.m.d" }}
                                </div>
                            </li>
                        {% empty %}
                            <li class="text-muted small italic">Nincs aktív időalapú csomagod.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    {% if pending_invoices %}
    <div class="card shadow-sm mb-5 border-0 rounded-4 overflow-hidden">
        <div class="card-header bg-danger text-white fw-bold py-3">
            <i class="bi bi-exclamation-circle me-2"></i> Fizetésre váró igénylések (Banki utalás)
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">Dátum</th>
                        <th>Csomag</th>
                        <th>Összeg</th>
                        <th>Státusz</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inv in pending_invoices %}
                    <tr>
                        <td class="ps-4 text-muted">{{ inv.created_at|date:"Y.m.d" }}</td>
                        <td class="fw-bold">{{ inv.plan.name }}</td>
                        <td class="fw-bold">{{ inv.amount_ft|intcomma }} Ft</td>
                        <td>
                            {% if inv.status == 'PENDING' %}
                                <span class="badge bg-warning text-dark rounded-pill"><i class="bi bi-hourglass-split"></i> Várakozás számlára</span>
                            {% elif inv.status == 'INVOICED' %}
                                <span class="badge bg-info rounded-pill"><i class="bi bi-envelope-paper"></i> Számla elküldve</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
        <div class="card-header bg-dark text-white fw-bold py-3 d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list-ul me-2"></i> Legutóbbi pénzügyi mozgások</span>
            <span class="badge bg-secondary font-weight-normal text-uppercase" style="font-size: 0.7rem;">Utolsó 10 tétel</span>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light text-secondary">
                    <tr>
                        <th class="ps-4">Időpont</th>
                        <th>Típus</th>
                        <th>Változás</th>
                        <th class="pe-4">Leírás</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trans in transactions %}
                    <tr>
                        <td class="ps-4 small text-muted">
                            <div class="fw-bold text-dark">{{ trans.timestamp|date:"Y.m.d" }}</div>
                            <div class="small">{{ trans.timestamp|date:"H:i" }}</div>
                        </td>
                        <td>
                            {% if trans.transaction_type == 'SPEND' %}
                                <span class="badge bg-danger bg-opacity-10 text-danger rounded-pill px-3">Kiadás</span>
                            {% elif trans.transaction_type == 'EARN' %}
                                <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3">Bevétel</span>
                            {% else %}
                                <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3">Szolgáltatás</span>
                            {% endif %}
                        </td>
                        <td class="fw-bold">
                            {% if trans.amount > 0 %}
                                <span class="text-success">+{{ trans.amount }} Cr</span>
                            {% elif trans.amount < 0 %}
                                <span class="text-danger">{{ trans.amount }} Cr</span>
                            {% else %}
                                <span class="text-primary"><i class="bi bi-patch-check-fill me-1"></i> AKTÍV</span>
                            {% endif %}
                        </td>
                        <td class="pe-4">
                            <div class="text-dark fw-medium">{{ trans.description }}</div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox d-block fs-1 mb-2 opacity-25"></i>
                            Még nem történt tranzakció a fiókodon.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}