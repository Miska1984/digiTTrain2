{% extends 'base.html' %}
{% load static %}

{% block title %}Testtart√°s elemz√©s ‚Äì Vide√≥ felt√∂lt√©se{% endblock %}

{% block content %}
<div class="container mx-auto py-6">
    <h2 class="text-2xl font-semibold mb-4">üé• Testtart√°s √ârt√©kel√©s ‚Äì Vide√≥ felt√∂lt√©se</h2>
    <p class="text-muted mb-4">K√©rj√ºk, t√∂lts√∂n fel egy **statikus, oldaln√©zeti** vide√≥t a testtart√°sr√≥l, hogy felm√©rhess√ºk a v√°ll √©s cs√≠p≈ë aszimmetri√°j√°t.</p>

    {# ‚ùó JAV√çTOTT: Elt√°vol√≠tva az enctype, hozz√°adva a data-attrib√∫tumok a JS-nek #}
    <form 
        id="upload-form" 
        method="post" 
        novalidate
        data-sign-url="{% url 'diagnostics:get_signed_gcs_url' %}"
        data-redirect-url="{% url 'diagnostics:athlete_diagnostics' %}"
    >
        {% csrf_token %}
        <div class="mb-3">
            <label for="id_video" class="form-label">Vide√≥ felt√∂lt√©se</label>
            <input type="file" name="video" accept="video/mp4" class="form-control" required>
            <div class="form-text">MP4 form√°tum, a teljes alak l√°that√≥ legyen oldalr√≥l.</div>
        </div>

        <div class="mb-3">
            <label for="id_notes" class="form-label">Megjegyz√©s (opcion√°lis)</label>
            <textarea name="notes" class="form-control" rows="3"></textarea>
        </div>

        {# üÜï √öJ: Felt√∂lt√©si folyamat jelz≈ëi #}
        <div id="progress-container" class="progress my-3" style="display:none;">
            <div id="upload-progress" class="progress-bar bg-success" style="width:0%">0%</div>
        </div>
        <div id="status-message" class="mt-2 text-muted"></div>

        <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-upload me-2"></i> Felt√∂lt√©s √©s elemz√©s ind√≠t√°sa
        </button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('upload-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const form = e.target;
        const videoInput = form.querySelector('input[name="video"]');
        const notes = form.querySelector('textarea[name="notes"]').value;
        const submitButton = form.querySelector('button[type="submit"]');

        const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
        const videoFile = videoInput.files[0];

        const statusMessage = document.getElementById('status-message');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('upload-progress');
        
        // Dinamikus adatok
        const signUrl = form.getAttribute('data-sign-url');
        const finalJobUrl = form.action || window.location.href; // A form posts to itself
        const redirectUrl = form.getAttribute('data-redirect-url');

        if (!videoFile) {
            statusMessage.className = 'mt-2 text-danger';
            statusMessage.textContent = '‚ùå K√©rj√ºk, v√°lasszon egy vide√≥f√°jlt a felt√∂lt√©shez.';
            return;
        }

        submitButton.disabled = true;
        progressContainer.style.display = 'block';
        statusMessage.className = 'mt-2 text-info';
        statusMessage.textContent = '‚è≥ 1/3: Al√°√≠rt URL ig√©nyl√©se a Google Cloud Storage-t√≥l...';

        try {
            // =========================================================
            // L√âP√âS 1: Al√°√≠rt URL ig√©nyl√©se a backendt≈ël
            // =========================================================
            const uniqueFileName = `${Date.now()}_${videoFile.name.replace(/[^a-zA-Z0-9._-]/g, '_')}`;

            const signResponse = await fetch(signUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({
                    file_name: uniqueFileName,
                    content_type: videoFile.type,
                }),
            });

            const signData = await signResponse.json();

            if (!signData.success) {
                throw new Error(signData.error || 'Hiba az al√°√≠rt URL ig√©nyl√©sekor.');
            }

            const { signed_url, file_name: gcs_object_name } = signData;
            console.log('üîó [DEBUG JS] GCS Objektum Neve (gcs_object_name):', gcs_object_name);
            statusMessage.textContent = '‚è≥ 2/3: Vide√≥ felt√∂lt√©se k√∂zvetlen√ºl a Google Cloud Storage-ra...';

            // =========================================================
            // L√âP√âS 2: K√∂zvetlen felt√∂lt√©s a GCS-re (PUT k√©r√©s)
            // =========================================================
            const xhr = new XMLHttpRequest();
            
            xhr.open('PUT', signed_url, true);
            // KRITIKUS: A GCS elv√°rja a Content-Type-ot a signed URL gener√°l√°s√°n√°l megadott √©rt√©kkel
            xhr.setRequestHeader('Content-Type', videoFile.type); 

            // Progress bar friss√≠t√©se
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percent + '%';
                    progressBar.textContent = percent + '%';
                    statusMessage.textContent = `‚è≥ 2/3: Felt√∂lt√©s folyamatban: ${percent}%`;
                }
            });

            await new Promise((resolve, reject) => {
                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve();
                    } else {
                        // A hiba a GCS-t≈ël j√∂n (pl. 403 Forbidden)
                        reject(new Error(`Hiba a GCS felt√∂lt√©skor. St√°tusz: ${xhr.status}. V√°lasz: ${xhr.responseText}`));
                    }
                };
                xhr.onerror = function() {
                    reject(new Error('H√°l√≥zati hiba a GCS felt√∂lt√©s sor√°n.'));
                };
                xhr.send(videoFile);
            });
            
            statusMessage.textContent = '‚úÖ 2/3: Felt√∂lt√©s sikeres. Job ind√≠t√°sa...';
            progressBar.classList.remove('bg-success');
            progressBar.classList.add('bg-primary');
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';

            // =========================================================
            // L√âP√âS 3: Job l√©trehoz√°sa a Django-ban (JSON POST)
            // =========================================================
            // A gcs_object_name a teljes GCS path, pl. videos/uploads/123456_fajl.mp4
            // A Django view fogja ebb≈ël gener√°lni a teljes URL-t.
            // üü¢ VADONAT√öJ DEBUG K√ìD ‚Äì Helyezd ide!
            if (!gcs_object_name) {
                console.error("‚ùå KRITIKUS JS HIBA: A gcs_object_name v√°ltoz√≥ hi√°nyzik vagy √ºres.");
                // Kil√©p√ºnk, hogy ne k√ºldj√ºk el a rossz JSON-t
                throw new Error("GCS felt√∂lt√©s siker√ºlt, de a f√°jln√©v (gcs_object_name) hi√°nyzik a Job ind√≠t√°s√°hoz.");
            }
            const requestBody = JSON.stringify({
                video_url: gcs_object_name, 
                notes: notes,
            });
            console.log('üîó [DEBUG JS] V√âGS≈ê POST K√©r√©s BODY:', requestBody);
            // üü¢ DEBUG V√âGE
            const finalPostResponse = await fetch(finalJobUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({
                    video_url: gcs_object_name, 
                    notes: notes,
                    // A job_type-ot √©s sport_type-ot a Django view-nak kell kezelnie a URL alapj√°n!
                }),
            });

            const finalData = await finalPostResponse.json();

            if (!finalData.success) {
                throw new Error(finalData.error || 'Hiba a Job l√©trehoz√°sakor/ind√≠t√°sakor.');
            }

            // Siker eset√©n √°tir√°ny√≠t√°s
            statusMessage.className = 'mt-2 text-success';
            statusMessage.textContent = `üéâ Sikeres: Job #${finalData.job_id} elindult. √Åtir√°ny√≠t√°s...`;
            const finalRedirectUrl = `${redirectUrl}?highlight_job=${finalData.job_id}`;
            window.location.href = finalRedirectUrl;


        } catch (error) {
            console.error(error);
            submitButton.disabled = false;
            progressBar.style.width = '0%';
            progressContainer.style.display = 'none';
            statusMessage.className = 'mt-2 text-danger';
            statusMessage.textContent = `‚ùå Hiba a felt√∂lt√©skor: ${error.message}`;
            
        }
    });
</script>
{% endblock %}

