{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        
        {# ========================================================= #}
        {# 1. Elemz√©si Lehet≈ës√©gek (Bal oldal: 3/12) #}
        {# ========================================================= #}
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm rounded-3 border-0 h-100">
                <div class="card-header bg-gradient-to-r from-blue-500 to-indigo-600 text-white fw-semibold">
                    Elemz√©si lehet≈ës√©gek
                </div>
                <div class="card-body space-y-2">
                    
                    <h5 class="fw-bold mb-3">√Åltal√°nos Elemz√©sek (Biomechanikai Alapok)</h5>
                    
                    {# GOMB: Testtart√°s felt√∂lt√©s #}
                    <a href="{% url 'diagnostics:upload_posture_video' %}" class="btn btn-outline-secondary w-100 mb-2">
                        üßç Testtart√°s √ârt√©kel√©s
                    </a>

                    {# GOMB: Guggol√°s felt√∂lt√©s #}
                    <a href="{% url 'diagnostics:upload_squat_video' %}" class="btn btn-outline-secondary w-100 mb-2">
                        üèãÔ∏è Guggol√°s Biomechanika
                    </a>

                    {# GOMB: V√°llk√∂rz√©s felt√∂lt√©s #}
                    <a href="{% url 'diagnostics:upload_shoulder_circumduction_video' %}" class="btn btn-outline-secondary w-100 mb-2">
                        ü§∏ V√°llk√∂rz√©s Biomechanika
                    </a>

                    {# GOMB: Magasugr√°s #}
                    <a href="{% url 'diagnostics:upload_vertical_jump_video' %}" class="btn btn-outline-secondary w-100 mb-2">
                        ü§∏ Magasugr√°s
                    </a>

                    <hr class="my-3">

                    <h5 class="fw-bold mb-3">Sportspecifikus elemz√©sek</h5>
                    {% if request.user.user_roles.all %}
                        <a href="{% url 'diagnostics:sport_diagnostics_list' %}" class="btn btn-primary w-100 mb-2">
                            <i class="fas fa-list-ul me-2"></i> Sport√°gi elemz√©sek list√°ja
                        </a>
                    {% else %}
                        <p class="text-muted text-center small">Nincs hozz√°rendelt sport√°gi diagnosztika.</p>
                    {% endif %}

                </div>
            </div>
        </div>
        
        {# ========================================================= #}
        {# 2. Elemz√©si Feladatok √©s Eredm√©nyek (Jobb oldal: 9/12) #}
        {#    Ez a s√°v most kit√∂lti a fennmarad√≥ helyet a jobb oldalon, bele√©rtve a k√∂z√©ps≈ë r√©szt is. #}
        {# ========================================================= #}
        <div class="col-md-9 mb-4">
            <div class="card shadow-sm rounded-3 border-0 h-100">
                <div class="card-header bg-gradient-to-r from-blue-500 to-indigo-600 text-white fw-semibold">
                    Elemz√©si feladatok √©s eredm√©nyek
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive p-3">
                        <table class="table table-striped table-hover align-middle" id="jobs-table">
                            <thead>
                                <tr>
                                    <th scope="col">T√≠pus</th>
                                    <th scope="col" class="text-center">D√°tum</th>
                                    <th scope="col" class="text-center">St√°tusz</th>
                                    
                                    <th scope="col" class="text-center">Riport</th>
                                    
                                </tr>
                            </thead>
                            <tbody id="jobs-list">
                                {% for job in job_list %}
                                    {# üí° FONTOS: Job ID √©s Job T√≠pus a JS sz√°m√°ra sz√ºks√©ges #}
                                    <tr data-job-id="{{ job.id }}" data-job-type="{{ job.job_type }}">
                                        <td>{{ job.get_job_type_display }}</td>
                                        <td data-cell="date" class="text-center">{{ job.created_at|date:"Y.m.d H:i" }}</td>
                                        <td data-cell="status" class="text-center">
                                            {# St√°tusz megjelen√≠t√©se az els≈ë bet√∂lt√©skor #}
                                            {% if job.status == 'COMPLETED' %}
                                                <span class="badge bg-success">K√©sz</span>
                                            {% elif job.status == 'PROCESSING' %}
                                                <span class="badge bg-warning text-dark">Folyamatban...</span>
                                            {% elif job.status == 'FAILED' %}
                                                <span class="badge bg-danger">Hiba</span>
                                            {% else %}
                                                <span class="badge bg-secondary">F√ºgg≈ëben</span>
                                            {% endif %}
                                        </td>
                                        <td data-cell="pdf" class="text-center">
                                            {# PDF gomb megjelen√≠t√©se #}
                                            {# 1. L√©p√©s: Biztons√°gosan kinyerj√ºk a report_pdf_url-t a job.result-b√≥l. Ha hi√°nyzik, √ºres stringet kapunk. #}
                                            {% with result_pdf_url=job.result.report_pdf_url|default:'' %}
                                                {# 2. L√©p√©s: Ellen≈ërizz√ºk, hogy a modell mez≈ë VAGY a result sz√≥t√°r √©rt√©ke l√©tezik-e. #}
                                                {% if job.pdf_path or result_pdf_url %}
                                                    {# A job.pdf_path-t haszn√°ljuk els≈ëdlegesen, √©s ha az √ºres, √°tv√°lt a result_pdf_url-re. #}
                                                    <a href="{{ job.pdf_path|default:result_pdf_url }}" target="_blank" class="btn btn-sm btn-outline-danger" title="Riport megtekint√©se"><i class="bi bi-file-earmark-pdf-fill me-1"></i> Riport</a>
                                                {% else %}
                                                    ‚Äì
                                                {% endif %}
                                            {% endwith %}
                                        </td>

                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">M√©g nem t√∂rt√©nt elemz√©s.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            {# üí° Google AdSense hirdet√©sek: A k√©r√©s szerint a base.html-b≈ël includolva, √≠gy itt nincs sz√ºks√©g r√°juk. #}
            {# Ha a hirdet√©s nem az eg√©sz oldal alatt jelenik meg, hanem itt kellene lennie, akkor itt lehet beilleszteni egy div-et a Google AdSense k√≥dj√°val. #}
            
        </div>
        
    </div>
</div>


<script>
// =========================================================
// JAV√çTOTT JAVASCRIPT BLOKK: Job Status Friss√≠t√©s √©s R√©szletes Eredm√©ny Megjelen√≠t√©s
// =========================================================
document.addEventListener("DOMContentLoaded", () => {
    // Be√°ll√≠that√≥ param√©terek
    const refreshInterval = 10000; // Friss√≠t√©si gyakoris√°g: 10 m√°sodperc.
    const jobStatusUrlTemplate = "/diagnostics/job-status/{jobId}/"; // A Django URL sablonja

    /**
     * @brief Dinamikusan l√©trehoz egy HTML gombot PDF linkkel.
     */
    function createPdfButton(url) {
        return url
            ? `<a href="${url}" target="_blank" class="btn btn-sm btn-outline-danger"><i class="bi bi-file-earmark-pdf-fill me-1"></i> Riport</a>`
            : "‚Äì";
    }
    
    /**
     * @brief Dinamikusan l√©trehoz egy HTML gombot vide√≥ linkkel.
     */
    function createVideoButton(url) {
        return url
            ? `<a href="${url}" download class="btn btn-sm btn-outline-info"><i class="fas fa-download me-1"></i> Let√∂lt√©s</a>`
            : "‚Äì";
    }

    /**
     * @brief Friss√≠ti a t√°bl√°zatban l√©v≈ë status badge-et √©s visszat√©r az √∫j HTML-lel.
     */
    function getStatusBadge(status) {
        switch (status) {
            case "COMPLETED":
                return `<span class="badge bg-success">K√©sz</span>`;
            case "PROCESSING":
                return `<span class="badge bg-warning text-dark">Folyamatban...</span>`;
            case "FAILED":
                return `<span class="badge bg-danger">Hiba</span>`;
            default:
                return `<span class="badge bg-info">F√ºgg≈ëben</span>`;
        }
    }

    /**
     * @brief Aszinkron m√≥don friss√≠ti az √∂sszes 'PENDING' vagy 'PROCESSING' st√°tusz√∫ feladat st√°tusz√°t.
     */
    async function refreshJobStatuses() {
        const rows = document.querySelectorAll("#jobs-table tbody tr");

        for (const row of rows) {
            const jobId = row.dataset.jobId;
            const currentStatus = row.dataset.jobStatus;
            const jobType = row.dataset.jobType; // üí° Kinyerj√ºk a job t√≠pus√°t!

            // Csak a f√ºgg≈ëben l√©v≈ë vagy folyamatban l√©v≈ë feladatokat friss√≠tj√ºk
            if (!jobId || currentStatus === "COMPLETED" || currentStatus === "FAILED") {
                continue;
            }

            try {
                const url = jobStatusUrlTemplate.replace("{jobId}", jobId);
                const res = await fetch(url);
                
                if (!res.ok) {
                    console.error(`HTTP hiba ${res.status} a job_id=${jobId} lek√©rdez√©s√©n√©l.`);
                    continue;
                }

                const data = await res.json();
                const newStatus = data.status;
                
                // Csak akkor friss√≠t√ºnk, ha az √°llapot v√°ltozott
                if (newStatus !== currentStatus) {
                    console.log(`‚úÖ Job ${jobId} friss√≠tve: ${currentStatus} -> ${newStatus}`);
                    
                    const statusCell = row.querySelector(".status-cell");
                    const resultCell = row.querySelector(".result-col");
                    const pdfCell = row.querySelector(".pdf-cell");
                    const videoCell = row.querySelector(".video-cell");

                    // Friss√≠tj√ºk a sor adatait √©s megjelen√≠t√©s√©t
                    row.dataset.jobStatus = newStatus; 
                    statusCell.innerHTML = getStatusBadge(newStatus); 
                    
                    if (newStatus === "COMPLETED") {
                        const resultData = data.result;
                        let resultHtml = resultData?.overall_rating || "‚Äì"; // Alap√©rtelmezett √©rt√©k

                        // üÜï POSTURE ASSESSMENT LOGIKA (Testtart√°s)
                        if (jobType === 'POSTURE_ASSESSMENT' && resultData) {
                            const shoulderTilt = resultData.avg_shoulder_tilt_deg ? resultData.avg_shoulder_tilt_deg.toFixed(1) + '¬∞' : '‚Äì';
                            const hipTilt = resultData.avg_hip_tilt_deg ? resultData.avg_hip_tilt_deg.toFixed(1) + '¬∞' : '‚Äì';
                            
                            resultHtml = `
                                <div class="small fw-bold mb-1">${resultData.overall_rating || '‚Äì'}</div>
                                <div class="small text-muted">V√°ll d≈ël√©s: ${shoulderTilt}</div>
                                <div class="small text-muted">Cs√≠p≈ë d≈ël√©s: ${hipTilt}</div>
                            `;
                        } 
                        // üÜï SQUAT ASSESSMENT LOGIKA (Guggol√°s)
                        else if (jobType === 'SQUAT_ASSESSMENT' && resultData) {
                            const avgRom = resultData.avg_rom_deg ? resultData.avg_rom_deg.toFixed(1) + '¬∞' : '‚Äì';
                            const overallScore = resultData.overall_score ? resultData.overall_score.toFixed(0) : '‚Äì';

                            resultHtml = `
                                <div class="small fw-bold mb-1">${resultData.overall_rating || '‚Äì'}</div>
                                <div class="small text-muted">√Åtl. ROM: ${avgRom}</div>
                                <div class="small text-muted">Pontsz√°m: ${overallScore} / 100</div>
                            `;
                        }


                        // Friss√≠tj√ºk a cell√°kat
                        resultCell.innerHTML = resultHtml; 
                        
                        // PDF URL-t tartalmazhatja a job (data.pdf_path) VAGY a result dict (data.result.report_pdf_url)
                        pdfCell.innerHTML = createPdfButton(data.pdf_path || data.result?.report_pdf_url);
                        // V√°zolt vide√≥ URL-je a result dict-b≈ël
                        videoCell.innerHTML = createVideoButton(data.result?.skeleton_video_url); 
                        
                    } else if (newStatus === "FAILED") {
                         // Hiba eset√©n
                        resultCell.innerHTML = "‚Äì"; 
                        pdfCell.innerHTML = "‚Äì";
                        videoCell.innerHTML = "‚Äì";
                    } else if (newStatus === "PROCESSING") {
                        // Folyamatban l√©v≈ë jobokn√°l
                        resultCell.innerHTML = "‚Äì"; 
                        pdfCell.innerHTML = "‚Äì";
                        videoCell.innerHTML = "‚Äì";
                    }
                }

            } catch (err) {
                console.warn(`‚ùå Nem siker√ºlt friss√≠teni a job_id=${jobId} √°llapot√°t. Hiba:`, err);
            }
        }
    }

    // Els≈ë futtat√°s √©s a friss√≠t√©si ciklus be√°ll√≠t√°sa
    setTimeout(() => {
        refreshJobStatuses();
        setInterval(refreshJobStatuses, refreshInterval);
    }, 100); 
});
</script>
{% endblock %}