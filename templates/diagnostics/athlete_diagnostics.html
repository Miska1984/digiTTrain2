{% extends "base.html" %}
{% load static diagnostics_extras %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- ========================================================= -->
        <!-- 1. BAL OLDALI PANEL: Elemz√©si lehet≈ës√©gek -->
        <!-- ========================================================= -->
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm rounded-3 border-0 h-100">
                <div class="card-header bg-gradient-to-r from-blue-500 to-indigo-600 text-white fw-semibold">
                    Elemz√©si lehet≈ës√©gek
                </div>
                <div class="card-body space-y-2">
                    <h5 class="fw-bold mb-3">√Åltal√°nos Elemz√©sek</h5>
                    <a href="{% url 'diagnostics:upload_posture_video' %}" class="btn btn-outline-secondary w-100 mb-2">
                        üßç Testtart√°s √ârt√©kel√©s
                    </a>
                    <a href="{% url 'diagnostics:upload_squat_video' %}" class="btn btn-outline-secondary w-100 mb-2">
                        üèãÔ∏è Guggol√°s Biomechanika
                    </a>
                    <a href="{% url 'diagnostics:upload_shoulder_circumduction_video' %}" class="btn btn-outline-secondary w-100 mb-2">
                        ü§∏ V√°llk√∂rz√©s Biomechanika
                    </a>
                    <a href="{% url 'diagnostics:upload_vertical_jump_video' %}" class="btn btn-outline-secondary w-100 mb-2">
                        üèÉ Magasugr√°s
                    </a>
                    <a href="{% url 'diagnostics:upload_single_leg_stance_unified' %}" class="btn btn-outline-secondary w-100 mb-2">
                        üßò Egyl√°bon √Åll√°s Elemz√©s
                    </a>

                    <hr class="my-3">

                    <h5 class="fw-bold mb-3">Sportspecifikus elemz√©sek</h5>
                    {% if request.user.user_roles.all %}
                        <a href="{% url 'diagnostics:sport_diagnostics_list' %}" class="btn btn-primary w-100 mb-2">
                            <i class="fas fa-list-ul me-2"></i> Sport√°gi elemz√©sek list√°ja
                        </a>
                    {% else %}
                        <p class="text-muted text-center small">Nincs sport√°gi diagnosztika.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ========================================================= -->
        <!-- 2. JOBB OLDAL: Diagnosztikai Eredm√©nyek -->
        <!-- ========================================================= -->
        <div class="col-md-9">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light fw-semibold">
                    üéØ Diagnosztikai eredm√©nyek
                </div>
                <div class="card-body">
                    {% if job_list %}
                        <div class="table-responsive">
                            <table id="jobs-table" class="table table-bordered align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>T√≠pus</th>
                                        <th>Sport√°g</th>
                                        <th>√Ållapot</th>
                                        <th>L√©trehozva</th>
                                        <th>Eredm√©ny (PDF)</th>
                                        <th>Skeleton Vide√≥</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for job in job_list %}
                                    <tr data-job-id="{{ job.id }}" 
                                        data-job-status="{{ job.status }}" 
                                        data-job-type="{{ job.job_type }}">
                                        <td>{{ job.id }}</td>
                                        <td>{{ job.get_job_type_display }}</td>
                                        <td>{{ job.sport_type|default:"√Åltal√°nos" }}</td>
                                        <td class="status-cell">
                                            {% if job.status == "COMPLETED" %}
                                                <span class="badge bg-success">K√©sz</span>
                                            {% elif job.status == "FAILED" %}
                                                <span class="badge bg-danger">Hiba</span>
                                            {% elif job.status == "PROCESSING" %}
                                                <span class="badge bg-warning text-dark">Feldolgoz√°s alatt</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ job.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ job.created_at|date:"Y.m.d H:i" }}</td>
                                        <td class="pdf-cell">
                                            {% if job.pdf_path %}
                                                <a href="{{ job.pdf_path }}" target="_blank" class="btn btn-sm btn-outline-danger">
                                                    üìÑ PDF jelent√©s
                                                </a>
                                            {% else %}
                                                <span class="text-muted">‚Äì</span>
                                            {% endif %}
                                        </td>
                                        <td class="video-cell">
                                            {% if job.result.skeleton_video_url %}
                                                <a href="{{ job.result.skeleton_video_url }}" download class="btn btn-sm btn-outline-info">
                                                    ‚¨áÔ∏è Skeleton vide√≥
                                                </a>
                                            {% else %}
                                                <span class="text-muted">‚Äì</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0">M√©g nincsenek diagnosztikai eredm√©nyek.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========================================================= -->
<!-- JAVASCRIPT: Job st√°tusz friss√≠t√©s √©s dinamikus tartalom -->
<!-- ========================================================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const refreshInterval = 10000;
    const jobStatusUrlTemplate = "/diagnostics/job-status/{jobId}/";

    function createPdfButton(url) {
        return url
            ? `<a href="${url}" target="_blank" class="btn btn-sm btn-outline-danger">
                <i class="bi bi-file-earmark-pdf-fill me-1"></i> PDF jelent√©s
               </a>`
            : "‚Äì";
    }

    function createVideoButton(url) {
        return url
            ? `<a href="${url}" download class="btn btn-sm btn-outline-info">
                <i class="fas fa-download me-1"></i> Skeleton vide√≥
               </a>`
            : "‚Äì";
    }

    function getStatusBadge(status) {
        switch (status) {
            case "COMPLETED": return `<span class="badge bg-success">K√©sz</span>`;
            case "PROCESSING": return `<span class="badge bg-warning text-dark">Folyamatban...</span>`;
            case "FAILED": return `<span class="badge bg-danger">Hiba</span>`;
            default: return `<span class="badge bg-secondary">F√ºgg≈ëben</span>`;
        }
    }

    async function refreshJobStatuses() {
        const rows = document.querySelectorAll("#jobs-table tbody tr");
        for (const row of rows) {
            const jobId = row.dataset.jobId;
            const currentStatus = row.dataset.jobStatus;
            if (!jobId || ["COMPLETED", "FAILED"].includes(currentStatus)) continue;

            try {
                const res = await fetch(jobStatusUrlTemplate.replace("{jobId}", jobId));
                if (!res.ok) continue;

                const data = await res.json();
                const newStatus = data.status;
                if (newStatus === currentStatus) continue;

                const statusCell = row.querySelector(".status-cell");
                const pdfCell = row.querySelector(".pdf-cell");
                const videoCell = row.querySelector(".video-cell");

                row.dataset.jobStatus = newStatus;
                if (statusCell) statusCell.innerHTML = getStatusBadge(newStatus);

                if (newStatus === "COMPLETED") {
                    const r = data.result || {};
                    if (pdfCell) pdfCell.innerHTML = createPdfButton(data.pdf_path || r.report_pdf_url);
                    if (videoCell) videoCell.innerHTML = createVideoButton(
                        r.skeleton_video_url || r.skeleton_video_left_url || r.skeleton_video_right_url
                    );
                }
            } catch (err) {
                console.warn(`‚ùå Nem siker√ºlt friss√≠teni a job_id=${jobId}:`, err);
            }
        }
    }

    setTimeout(() => {
        refreshJobStatuses();
        setInterval(refreshJobStatuses, refreshInterval);
    }, 200);
});
</script>
{% endblock %}
