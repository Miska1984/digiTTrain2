{% extends "base.html" %}
{% load static diagnostics_extras %}

{% block content %}
<div class="container-fluid py-4">
    
    {# üÜï √öJ: ELEMZ√âSI EGYENLEG BANNER #}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0 bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1 fw-bold">
                            <i class="bi bi-graph-up-arrow me-2"></i> El√©rhet≈ë Elemz√©sek
                        </h4>
                        <p class="mb-0 small opacity-90">
                            Jelenlegi egyenleg: <strong class="fs-3">{{ analysis_balance }} db</strong>
                        </p>
                    </div>
                    <div class="text-end">
                        {% if analysis_balance < 5 %}
                            <a href="{% url 'billing:billing_purchase' %}" class="btn btn-warning btn-lg">
                                <i class="bi bi-cart-plus-fill me-2"></i> V√°s√°rl√°s
                            </a>
                        {% else %}
                            <span class="badge bg-success fs-5 px-4 py-2">Elegend≈ë egyenleg</span>
                        {% endif %}
                        <a href="{% url 'billing:ad_credit_earn' %}" class="btn btn-outline-light btn-sm mt-2">
                            <i class="bi bi-gift-fill me-1"></i> Ingyenes elemz√©s szerz√©se
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- ========================================================= -->
        <!-- 1. BAL OLDALI PANEL: Elemz√©si lehet≈ës√©gek -->
        <!-- ========================================================= -->
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm rounded-3 border-0 h-100">
                <div class="card-header bg-gradient-to-r from-blue-500 to-indigo-600 text-white fw-semibold">
                    Elemz√©si lehet≈ës√©gek
                </div>
                <div class="card-body space-y-2">
                    <h5 class="fw-bold mb-3">√Åltal√°nos Elemz√©sek</h5>
                    
                    {# üÜï Gombokhoz egyenleg ellen≈ërz√©s #}
                    {% if analysis_balance > 0 %}
                        <a href="{% url 'diagnostics:upload_posture_video' %}" class="btn btn-outline-secondary w-100 mb-2">
                            üßç Testtart√°s √ârt√©kel√©s
                        </a>
                        <a href="{% url 'diagnostics:upload_squat_video' %}" class="btn btn-outline-secondary w-100 mb-2">
                            üèãÔ∏è Gugol√°s Biomechanika
                        </a>
                        <a href="{% url 'diagnostics:upload_shoulder_circumduction_video' %}" class="btn btn-outline-secondary w-100 mb-2">
                            ü§∏ V√°llk√∂rz√©s Biomechanika
                        </a>
                        <a href="{% url 'diagnostics:upload_vertical_jump_video' %}" class="btn btn-outline-secondary w-100 mb-2">
                            üèÉ Magasugr√°s
                        </a>
                        <a href="{% url 'diagnostics:upload_single_leg_stance_unified' %}" class="btn btn-outline-secondary w-100 mb-2">
                            üßò Egyl√°bon √Åll√°s Elemz√©s
                        </a>
                    {% else %}
                        {# Ha nincs egyenleg, letiltott gombok #}
                        <button class="btn btn-outline-secondary w-100 mb-2" disabled>
                            üßç Testtart√°s √ârt√©kel√©s <span class="badge bg-danger ms-2">0 db</span>
                        </button>
                        <button class="btn btn-outline-secondary w-100 mb-2" disabled>
                            üèãÔ∏è Gugol√°s Biomechanika <span class="badge bg-danger ms-2">0 db</span>
                        </button>
                        <button class="btn btn-outline-secondary w-100 mb-2" disabled>
                            ü§∏ V√°llk√∂rz√©s Biomechanika <span class="badge bg-danger ms-2">0 db</span>
                        </button>
                        <button class="btn btn-outline-secondary w-100 mb-2" disabled>
                            üèÉ Magasugr√°s <span class="badge bg-danger ms-2">0 db</span>
                        </button>
                        <button class="btn btn-outline-secondary w-100 mb-2" disabled>
                            üßò Egyl√°bon √Åll√°s <span class="badge bg-danger ms-2">0 db</span>
                        </button>
                        
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            <strong>Nincs elemz√©si egyenleged!</strong><br>
                            <a href="{% url 'billing:billing_purchase' %}" class="alert-link">V√°s√°rolj csomagot</a> vagy 
                            <a href="{% url 'billing:ad_credit_earn' %}" class="alert-link">szerezz ingyen</a>!
                        </div>
                    {% endif %}

                    <hr class="my-3">

                    <h5 class="fw-bold mb-3">Sportspecifikus elemz√©sek</h5>
                    {% if request.user.user_roles.all %}
                        {% if analysis_balance > 0 %}
                            <a href="{% url 'diagnostics:sport_diagnostics_list' %}" class="btn btn-primary w-100 mb-2">
                                <i class="fas fa-list-ul me-2"></i> Sport√°gi elemz√©sek list√°ja
                            </a>
                        {% else %}
                            <button class="btn btn-primary w-100 mb-2" disabled>
                                <i class="fas fa-list-ul me-2"></i> Sport√°gi elemz√©sek 
                                <span class="badge bg-danger ms-2">0 db</span>
                            </button>
                        {% endif %}
                    {% else %}
                        <p class="text-muted text-center small">Nincs sport√°gi diagnosztika.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ========================================================= -->
        <!-- 2. JOBB OLDAL: Diagnosztikai Eredm√©nyek -->
        <!-- ========================================================= -->
        <div class="col-md-9">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light fw-semibold d-flex justify-content-between align-items-center">
                    <span>üéØ Diagnosztikai eredm√©nyek</span>
                    <span class="badge bg-primary">√ñsszesen: {{ job_list.count }} elemz√©s</span>
                </div>
                <div class="card-body">
                    {% if job_list %}
                        <div class="table-responsive">
                            <table id="jobs-table" class="table table-bordered align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>T√≠pus</th>
                                        <th>Sport√°g</th>
                                        <th>√Ållapot</th>
                                        <th>L√©trehozva</th>
                                        <th>Eredm√©ny (PDF)</th>
                                        <th>Skeleton Vide√≥</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for job in job_list %}
                                    <tr data-job-id="{{ job.id }}" 
                                        data-job-status="{{ job.status }}" 
                                        data-job-type="{{ job.job_type }}">
                                        <td>{{ job.id }}</td>
                                        <td>{{ job.get_job_type_display }}</td>
                                        <td>{{ job.sport_type|default:"√Åltal√°nos" }}</td>
                                        <td class="status-cell">
                                            {% if job.status == "COMPLETED" %}
                                                <span class="badge bg-success">K√©sz</span>
                                            {% elif job.status == "FAILED" %}
                                                <span class="badge bg-danger">Hiba</span>
                                            {% elif job.status == "PROCESSING" %}
                                                <span class="badge bg-warning text-dark">Feldolgoz√°s alatt</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ job.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ job.created_at|date:"Y.m.d H:i" }}</td>
                                        <td class="pdf-cell">
                                            {% if job.pdf_path %}
                                                <a href="{{ job.pdf_path }}" target="_blank" class="btn btn-sm btn-outline-danger">
                                                    üìÑ PDF jelent√©s
                                                </a>
                                            {% else %}
                                                <span class="text-muted">‚Äî</span>
                                            {% endif %}
                                        </td>
                                        <td class="video-cell">
                                            {% with result=job.result %}
                                                {% if "SINGLE_LEG_STANCE_LEFT" in job.job_type and result.skeleton_video_left_url %}
                                                    <a href="{{ result.skeleton_video_left_url }}" target="_blank" class="btn btn-sm btn-outline-info">
                                                        <i class="bi bi-camera-reels me-1"></i> Bal Vide√≥
                                                    </a>
                                                {% elif "SINGLE_LEG_STANCE_RIGHT" in job.job_type and result.skeleton_video_right_url %}
                                                    <a href="{{ result.skeleton_video_right_url }}" target="_blank" class="btn btn-sm btn-outline-info">
                                                        <i class="bi bi-camera-reels me-1"></i> Jobb Vide√≥
                                                    </a>
                                                {% elif result.skeleton_video_url %}
                                                    <a href="{{ result.skeleton_video_url }}" target="_blank" class="btn btn-sm btn-outline-info">
                                                        <i class="bi bi-camera-reels me-1"></i> Vide√≥
                                                    </a>
                                                {% else %}
                                                    <span class="text-muted">‚Äî</span>
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            M√©g nincsenek diagnosztikai eredm√©nyek. Kezdj el elemz√©seket!
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========================================================= -->
<!-- JAVASCRIPT: Job st√°tusz friss√≠t√©s √©s dinamikus tartalom -->
<!-- ========================================================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const refreshInterval = 10000;
    const jobStatusUrlTemplate = "/diagnostics/job-status/{jobId}/";

    function createPdfButton(url) {
        return url
            ? `<a href="${url}" target="_blank" class="btn btn-sm btn-outline-danger">
                <i class="bi bi-file-earmark-pdf-fill me-1"></i> PDF jelent√©s
               </a>`
            : "‚Äî";
    }

    function createVideoButton(url) {
        return url
            ? `<a href="${url}" download class="btn btn-sm btn-outline-info">
                <i class="fas fa-download me-1"></i> Skeleton vide√≥
               </a>`
            : "‚Äî";
    }

    function getStatusBadge(status) {
        switch (status) {
            case "COMPLETED": return `<span class="badge bg-success">K√©sz</span>`;
            case "PROCESSING": return `<span class="badge bg-warning text-dark">Folyamatban...</span>`;
            case "FAILED": return `<span class="badge bg-danger">Hiba</span>`;
            default: return `<span class="badge bg-secondary">F√ºgg≈ëben</span>`;
        }
    }

    async function refreshJobStatuses() {
        const rows = document.querySelectorAll("#jobs-table tbody tr");
        for (const row of rows) {
            const jobId = row.dataset.jobId;
            const currentStatus = row.dataset.jobStatus;
            if (!jobId || ["COMPLETED", "FAILED"].includes(currentStatus)) continue;

            try {
                const res = await fetch(jobStatusUrlTemplate.replace("{jobId}", jobId));
                if (!res.ok) continue;

                const data = await res.json();
                const newStatus = data.status;
                if (newStatus === currentStatus) continue;

                const statusCell = row.querySelector(".status-cell");
                const pdfCell = row.querySelector(".pdf-cell");
                const videoCell = row.querySelector(".video-cell");

                row.dataset.jobStatus = newStatus;
                if (statusCell) statusCell.innerHTML = getStatusBadge(newStatus);

                if (newStatus === "COMPLETED") {
                    const r = data.result || {};
                    if (pdfCell) pdfCell.innerHTML = createPdfButton(data.pdf_path || r.report_pdf_url);
                    if (videoCell) videoCell.innerHTML = createVideoButton(
                        r.skeleton_video_url || r.skeleton_video_left_url || r.skeleton_video_right_url
                    );
                }
            } catch (err) {
                console.warn(`‚ùå Nem siker√ºlt friss√≠teni a job_id=${jobId}:`, err);
            }
        }
    }

    setTimeout(() => {
        refreshJobStatuses();
        setInterval(refreshJobStatuses, refreshInterval);
    }, 200);
});
</script>
{% endblock %}