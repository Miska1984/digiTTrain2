{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <!-- üü¶ Oldals√°v -->
    <div class="col-md-3 mb-4">
      <div class="card shadow-sm rounded-3 border-0">
        <div class="card-header bg-gradient-to-r from-blue-500 to-indigo-600 text-white fw-semibold">
          Sportspecifikus elemz√©sek
        </div>
        <div class="card-body space-y-2">
          {% if request.user.user_roles.all %}
            {% for role in request.user.user_roles.all %}
              {% if role.sport %}
                <a href="#" class="btn btn-outline-primary w-100 mb-2">
                  {{ role.sport.name }} elemz√©s
                </a>
              {% endif %}
            {% endfor %}
          {% else %}
            <p class="text-muted text-center">Nincs el√©rhet≈ë sport specifikus elemz√©s</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- üü© F≈ë tartalom -->
    <div class="col-md-9">
      <h2 class="mb-4 fw-bold text-gray-800">√Åltal√°nos mozg√°selemz√©s</h2>

      <!-- üß† Elemz√©si k√°rty√°k -->
      <div class="row g-4">
        <!-- Testtart√°s -->
        <div class="col-md-6">
          <div class="card shadow-sm h-100 border-0 rounded-4">
            <img src="{% static 'images/placeholders/posture.gif' %}" class="card-img-top rounded-top-4" alt="Testtart√°s elemz√©s">
            <div class="card-body">
              <h5 class="card-title fw-semibold">Testtart√°s elemz√©s</h5>
              <p class="text-muted small">Vizsg√°lja a test szimmetri√°j√°t, v√°ll-, cs√≠p≈ë- √©s t√©rdpoz√≠ci√≥kat.</p>
              <a href="{% url 'diagnostics:upload_general_video' %}" class="btn btn-primary w-100">Vide√≥ felt√∂lt√©se</a>
            </div>
          </div>
        </div>

        <!-- Egyens√∫ly -->
        <div class="col-md-6">
          <div class="card shadow-sm h-100 border-0 rounded-4">
            <img src="{% static 'images/placeholders/balance.gif' %}" class="card-img-top rounded-top-4" alt="Egyens√∫ly elemz√©s">
            <div class="card-body">
              <h5 class="card-title fw-semibold">Egyens√∫ly elemz√©s</h5>
              <p class="text-muted small">Elemzi a stabilit√°st √©s s√∫lypontv√°ltoz√°st mozg√°s k√∂zben.</p>
              <a href="#" class="btn btn-outline-primary w-100">Vide√≥ felt√∂lt√©se</a>
            </div>
          </div>
        </div>

        <!-- Guggol√°s -->
        <div class="col-md-6">
          <div class="card shadow-sm h-100 border-0 rounded-4">
            <img src="{% static 'images/placeholders/squat.gif' %}" class="card-img-top rounded-top-4" alt="Guggol√°s elemz√©s">
            <div class="card-body">
              <h5 class="card-title fw-semibold">Guggol√°s elemz√©s</h5>
              <p class="text-muted small">T√©rd- √©s cs√≠p≈ësz√∂gek, mozg√°startom√°ny √©s szimmetria √©rt√©kel√©se.</p>
              <a href="#" class="btn btn-outline-primary w-100">Vide√≥ felt√∂lt√©se</a>
            </div>
          </div>
        </div>

        <!-- Fut√≥mozg√°s -->
        <div class="col-md-6">
          <div class="card shadow-sm h-100 border-0 rounded-4">
            <img src="{% static 'images/placeholders/running.gif' %}" class="card-img-top rounded-top-4" alt="Fut√≥mozg√°s elemz√©s">
            <div class="card-body">
              <h5 class="card-title fw-semibold">Fut√≥mozg√°s elemz√©s</h5>
              <p class="text-muted small">Kar- √©s l√°bmozg√°sok, l√©p√©shossz √©s ritmus kiegyens√∫lyozotts√°ga.</p>
              <a href="#" class="btn btn-outline-primary w-100">Vide√≥ felt√∂lt√©se</a>
            </div>
          </div>
        </div>

        <!-- V√°llmobilit√°s -->
        <div class="col-md-6">
          <div class="card shadow-sm h-100 border-0 rounded-4">
            <img src="{% static 'images/placeholders/shoulder.gif' %}" class="card-img-top rounded-top-4" alt="V√°llmobilit√°s elemz√©s">
            <div class="card-body">
              <h5 class="card-title fw-semibold">V√°llmobilit√°s elemz√©s</h5>
              <p class="text-muted small">Kar- √©s v√°ll√≠z√ºleti mozg√°sterjedelem vizsg√°lata.</p>
              <a href="#" class="btn btn-outline-primary w-100">Vide√≥ felt√∂lt√©se</a>
            </div>
          </div>
        </div>
      </div>

      <!-- üìä Kor√°bbi elemz√©sek -->
      <div class="mt-5">
        <h4 class="fw-semibold mb-3">Kor√°bbi elemz√©sek</h4>
        {% if jobs %}
          <div class="table-responsive">
            <table class="table table-hover align-middle shadow-sm rounded-3" id="jobs-table">
              <thead class="table-light">
                <tr>
                  <th>T√≠pus</th>
                  <th>St√°tusz</th>
                  <th>D√°tum</th>
                  <th>√Åltal√°nos √©rt√©kel√©s</th>
                  <th class="text-center">PDF Riport</th>
                </tr>
              </thead>
              <tbody>
                {% for job in jobs %}
                  <tr data-job-id="{{ job.id }}">
                    <td>{{ job.job_type|title }}</td>
                    <td class="status-cell">
                      {% if job.status == "completed" %}
                        <span class="badge bg-success">K√©sz</span>
                      {% elif job.status == "failed" %}
                        <span class="badge bg-danger">Hiba</span>
                      {% else %}
                        <span class="badge bg-warning text-dark">Folyamatban</span>
                      {% endif %}
                    </td>
                    <td>{{ job.created_at|date:"Y.m.d H:i" }}</td>
                    <td class="result-cell">
                      {% if job.result %}
                        {{ job.result.overall_rating|default:"‚Äì" }}
                      {% else %}
                        <span class="text-muted">‚Äì</span>
                      {% endif %}
                    </td>
                    <td class="text-center pdf-cell">
                      {% if job.status == "completed" and job.result.report_pdf_url %}
                        <a href="{{ job.result.report_pdf_url }}" target="_blank" class="btn btn-sm btn-outline-danger">
                          <i class="bi bi-file-earmark-pdf-fill me-1"></i> Megnyit√°s
                        </a>
                      {% else %}
                        <span class="text-muted small fst-italic">Nincs riport</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted fst-italic">M√©g nem t√∂rt√©nt elemz√©s.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- üîÅ Automatikus st√°tuszfriss√≠t√©s -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const refreshInterval = 30000; // 30 m√°sodperc

  async function refreshJobStatuses() {
    const rows = document.querySelectorAll("#jobs-table tbody tr");
    for (const row of rows) {
      const jobId = row.dataset.jobId;
      if (!jobId) continue;

      try {
        const res = await fetch(`/diagnostics/job_status/${jobId}/`);
        if (!res.ok) continue;

        const data = await res.json();
        const statusCell = row.querySelector(".status-cell");
        const resultCell = row.querySelector(".result-cell");
        const pdfCell = row.querySelector(".pdf-cell");

        if (data.status === "completed") {
          statusCell.innerHTML = `<span class="badge bg-success">K√©sz</span>`;
          resultCell.innerHTML = data.result?.overall_rating || "‚Äì";
          if (data.result?.report_pdf_url) {
            pdfCell.innerHTML = `<a href="${data.result.report_pdf_url}" target="_blank" class="btn btn-sm btn-outline-danger"><i class="bi bi-file-earmark-pdf-fill me-1"></i> Megnyit√°s</a>`;
          }
        } else if (data.status === "failed") {
          statusCell.innerHTML = `<span class="badge bg-danger">Hiba</span>`;
        } else {
          statusCell.innerHTML = `<span class="badge bg-warning text-dark">Folyamatban</span>`;
        }
      } catch (err) {
        console.warn("Nem siker√ºlt friss√≠teni a st√°tuszt:", err);
      }
    }
  }

  setInterval(refreshJobStatuses, refreshInterval);
});
</script>
{% endblock %}
