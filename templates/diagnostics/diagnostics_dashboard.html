{% extends 'base.html' %}
{% load static %}

{% block title %}Diagnosztikai Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto mt-5">
    <h2 class="text-center mb-4 text-2xl fw-bold text-primary">üéØ Diagnosztikai Elemz√©sek</h2>

    <!-- √öj elemz√©s ind√≠t√°sa -->
    <div class="card shadow mb-5">
        <div class="card-header bg-dark text-white fw-bold">√öj vide√≥ elemz√©se</div>
        <div class="card-body">
            <form id="createJobForm">
                <div class="mb-3">
                    <label for="videoUrl" class="form-label">Vide√≥ URL (Google Storage link)</label>
                    <input type="url" class="form-control" id="videoUrl" name="video_url" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Elemz√©s ind√≠t√°sa</button>
            </form>
            <div id="createJobMessage" class="mt-3 text-center"></div>
        </div>
    </div>

    <!-- Diagnosztikai eredm√©nyek -->
    <div class="card shadow">
        <div class="card-header bg-secondary text-white fw-bold">Kor√°bbi diagnosztikai elemz√©sek</div>
        <div class="card-body">
            <table class="table table-striped text-center align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Sport√°g</th>
                        <th>T√≠pus</th>
                        <th>St√°tusz</th>
                        <th>L√©trehozva</th>
                        <th>Eredm√©ny</th>
                    </tr>
                </thead>
                <tbody id="jobList">
                    {% for job in jobs %}
                    <tr>
                        <td>{{ job.id }}</td>
                        <td>{{ job.sport_type }}</td>
                        <td>{{ job.job_type }}</td>
                        <td>
                            {% if job.status == "completed" %}
                                <span class="badge bg-success">K√©sz</span>
                            {% elif job.status == "failed" %}
                                <span class="badge bg-danger">Hiba</span>
                            {% elif job.status == "running" %}
                                <span class="badge bg-warning text-dark">Fut</span>
                            {% else %}
                                <span class="badge bg-secondary">F√ºgg≈ëben</span>
                            {% endif %}
                        </td>
                        <td>{{ job.created_at|date:"Y.m.d H:i" }}</td>
                        <td>
                            {% if job.result %}
                                <button class="btn btn-sm btn-outline-primary viewResultBtn" data-result='{{ job.result|safe }}'>
                                    <i class="bi bi-graph-up"></i> Megtekint√©s
                                </button>
                            {% else %}
                                <span class="text-muted">Nincs adat</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-muted">M√©g nincs elemz√©s ind√≠tva.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Eredm√©ny modal -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Diagnosztikai eredm√©ny</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <canvas id="resultChart"></canvas>
                    <div id="resultDetails" class="mt-3 text-center"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {

    // --- √öj elemz√©s ind√≠t√°sa ---
    $('#createJobForm').on('submit', function(e) {
        e.preventDefault();
        const videoUrl = $('#videoUrl').val();
        $('#createJobMessage').html('<div class="text-info">‚è≥ Elemz√©s l√©trehoz√°sa...</div>');

        $.ajax({
            url: '/diagnostics/create/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                user_id: {{ request.user.id }},
                sport_type: "wrestling",
                job_type: "wrestling",
                video_url: videoUrl
            }),
            success: function(response) {
                $('#createJobMessage').html('<div class="text-success">‚úÖ Elemz√©s sikeresen l√©trehozva!</div>');
                loadJobList(); // Friss√≠t√©s azonnal
            },
            error: function(err) {
                $('#createJobMessage').html('<div class="text-danger">‚ùå Hiba t√∂rt√©nt: ' + err.responseJSON.error + '</div>');
            }
        });
    });


    // --- St√°tuszok automatikus friss√≠t√©se ---
    function loadJobList() {
        $.ajax({
            url: '/diagnostics/list/?user_id={{ request.user.id }}',
            type: 'GET',
            success: function(response) {
                const tbody = $('#jobList');
                tbody.empty();

                if (response.jobs.length === 0) {
                    tbody.append('<tr><td colspan="6" class="text-muted">M√©g nincs elemz√©s ind√≠tva.</td></tr>');
                } else {
                    response.jobs.forEach(job => {
                        const badgeClass = job.status === 'completed' ? 'bg-success' :
                                           job.status === 'running' ? 'bg-warning text-dark' :
                                           job.status === 'failed' ? 'bg-danger' :
                                           'bg-secondary';
                        const resultBtn = job.result
                            ? `<button class="btn btn-sm btn-outline-primary viewResultBtn" data-result='${JSON.stringify(job.result)}'>
                                <i class="bi bi-graph-up"></i> Megtekint√©s
                               </button>`
                            : '<span class="text-muted">Nincs adat</span>';

                        tbody.append(`
                            <tr>
                                <td>${job.id}</td>
                                <td>${job.sport_type}</td>
                                <td>${job.job_type}</td>
                                <td><span class="badge ${badgeClass}">${job.status}</span></td>
                                <td>${new Date(job.created_at).toLocaleString()}</td>
                                <td>${resultBtn}</td>
                            </tr>
                        `);
                    });
                }

                // √öjra inicializ√°ljuk a gombokat
                initViewResultButtons();
            }
        });
    }

    // --- Eredm√©ny megtekint√©se modalban ---
    function initViewResultButtons() {
        $('.viewResultBtn').off('click').on('click', function() {
            const result = JSON.parse($(this).attr('data-result'));
            const ctx = document.getElementById('resultChart').getContext('2d');

            const chartData = {
                labels: ['Egyens√∫ly', 'Robban√©konys√°g', 'Markolat ar√°ny'],
                datasets: [{
                    label: 'Teljes√≠tm√©ny mutat√≥k',
                    data: [result.balance_stability, result.explosiveness_score, result.grip_strength_ratio * 100],
                    backgroundColor: 'rgba(54, 162, 235, 0.3)',
                    borderColor: 'rgb(54, 162, 235)',
                    borderWidth: 2
                }]
            };

            new Chart(ctx, { type: 'radar', data: chartData });

            $('#resultDetails').html(`<p><strong>S√©r√ºl√©skock√°zat:</strong> ${result.predicted_injury_risk}</p>`);
            const modal = new bootstrap.Modal(document.getElementById('resultModal'));
            modal.show();
        });
    }

    // --- 30 m√°sodpercenk√©nt automatikus friss√≠t√©s ---
    loadJobList();
    setInterval(loadJobList, 30000);
});
</script>
{% endblock %}

