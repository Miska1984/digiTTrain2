{% extends 'base.html' %}
{% load static %}

{% block title %}V√°llk√∂rz√©s elemz√©s ‚Äì Vide√≥ felt√∂lt√©se{% endblock %}

{% block content %}
<div class="container mx-auto py-6">
    <h2 class="text-2xl font-semibold mb-4">ü§∏ V√°llk√∂rz√©s √ârt√©kel√©s ‚Äì Vide√≥ felt√∂lt√©se</h2>
    <p class="text-muted mb-4">K√©rj√ºk, t√∂lts√∂n fel egy vide√≥t, ami **5 k√∂r el≈ëre √©s 5 k√∂r h√°tra** v√°llk√∂rz√©st mutat be. A kamera legyen **szemb≈ël (front√°lis) elhelyezve**, hogy mindk√©t kar √©s a teljes t√∂rzs l√°that√≥ legyen.</p>

    {# GCS felt√∂lt√©si logika: Elt√°vol√≠tva az enctype="multipart/form-data" √©s hozz√°adva a data-attrib√∫tumok a JS-nek #}
    <form 
        id="upload-form" 
        method="post" 
        novalidate
        data-sign-url="{% url 'diagnostics:get_signed_gcs_url' %}"
        data-redirect-url="{% url 'diagnostics:athlete_diagnostics' %}"
    >
        {% csrf_token %}
        <div class="mb-3">
            <label for="id_video" class="form-label">Vide√≥ felt√∂lt√©se</label>
            <input type="file" name="video" accept="video/mp4" class="form-control" required>
            <div class="form-text">MP4 form√°tum, a teljes mozg√°s √©s a t√∂rzs l√°that√≥ legyen szemb≈ël.</div>
        </div>

        <div class="mb-3">
            <label for="id_notes" class="form-label">Megjegyz√©s (opcion√°lis)</label>
            <textarea name="notes" id="id_notes" class="form-control" rows="3"></textarea>
            <div class="form-text">B√°rmilyen fontos inform√°ci√≥ a mozg√°sr√≥l vagy esetleges f√°jdalomr√≥l.</div>
        </div>

        <button type="submit" id="submit-button" class="btn btn-primary mt-3">
            <span id="submit-spinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
            Vide√≥ felt√∂lt√©se √©s elemz√©s ind√≠t√°sa
        </button>

        <div id="progress-container" class="mt-4" style="display:none;">
            <div class="progress" role="progressbar" aria-label="Felt√∂lt√©s folyamatban" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>
        <div id="status-message" class="mt-2 text-info"></div>

    </form>
</div>

{# A JavaScript k√≥d a GCS felt√∂lt√©shez √©s a Job ind√≠t√°s√°hoz (Ahogy a squat_video.html-ben is van) #}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('upload-form');
        const submitButton = document.getElementById('submit-button');
        const submitSpinner = document.getElementById('submit-spinner');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const statusMessage = document.getElementById('status-message');

        const signUrl = form.getAttribute('data-sign-url');
        const redirectUrl = form.getAttribute('data-redirect-url');
        const finalJobUrl = "{% url 'diagnostics:upload_shoulder_circumduction_video' %}"; 
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;


        form.addEventListener('submit', async function (event) {
            event.preventDefault();
            
            const fileInput = form.querySelector('input[name="video"]');
            const videoFile = fileInput.files[0];
            const notes = form.querySelector('textarea[name="notes"]').value;

            if (!videoFile) {
                statusMessage.className = 'mt-2 text-danger';
                statusMessage.textContent = 'K√©rj√ºk, v√°lasszon egy MP4 vide√≥f√°jlt!';
                return;
            }

            // UI friss√≠t√©se
            submitButton.disabled = true;
            submitSpinner.classList.remove('d-none');
            progressContainer.style.display = 'block';
            statusMessage.className = 'mt-2 text-info';
            statusMessage.textContent = '1/2: Felt√∂lt√©si adatok k√©r√©se...';
            progressBar.style.width = '0%';
            
            
            try {
                // 1. Al√°√≠rt GCS URL k√©r√©se (GCS sign URL)
                const signResponse = await fetch(signUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({
                        filename: videoFile.name,
                        content_type: videoFile.type || 'video/mp4',
                    }),
                });
                
                const signData = await signResponse.json();
                
                if (!signData.success) {
                    throw new Error(signData.error || 'Hiba az al√°√≠rt URL k√©r√©sekor.');
                }
                
                const gcsSignedUrl = signData.signed_url;
                
                // ‚ùó KRITIKUS JAV√çT√ÅS: A gcs_signer.py a 'file_name' kulcsot haszn√°lja a GCS el√©r√©si √∫tra
                const gcs_object_key = signData.file_name; 
                
                statusMessage.textContent = '2/2: Vide√≥ felt√∂lt√©se a Google Cloud Storage-ra...';

                // 2. F√°jl felt√∂lt√©se k√∂zvetlen√ºl a GCS-re a kapott URL-lel (PUT k√©r√©s)
                const uploadResponse = await fetch(gcsSignedUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': videoFile.type || 'video/mp4',
                    },
                    body: videoFile,
                });

                if (!uploadResponse.ok) {
                    const errorText = await uploadResponse.text();
                    throw new Error(`GCS felt√∂lt√©si hiba (HTTP ${uploadResponse.status}).`);
                }

                statusMessage.textContent = '2/2: Felt√∂ltve. Job ind√≠t√°sa a szerveren...';

                // 3. Jelz√©s a Django szervernek a felt√∂lt√©s sikeress√©g√©r≈ël √©s a Job ind√≠t√°s√°r√≥l
                const finalPostResponse = await fetch(finalJobUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({
                        video_url: gcs_object_key, // ‚¨ÖÔ∏è Ezt haszn√°lja a Django Job!
                        notes: notes,
                    }),
                });

                let finalData;
                const errorText = await finalPostResponse.text(); 
                
                try {
                    finalData = JSON.parse(errorText);
                } catch (e) {
                     throw new Error(`Kritikus Django hiba a Job ind√≠t√°sakor. St√°tusz: ${finalPostResponse.status}. V√°lasz: ${errorText.substring(0, 100)}...`);
                }

                if (!finalData.success) {
                    throw new Error(finalData.error || 'Hiba a Job l√©trehoz√°sakor/ind√≠t√°sakor (a szerver JSON-t adott, de success: false).');
                }

                // Siker eset√©n √°tir√°ny√≠t√°s
                statusMessage.className = 'mt-2 text-success';
                statusMessage.textContent = `üéâ Sikeres: Job #${finalData.job_id} elindult. √Åtir√°ny√≠t√°s...`;
                
                const finalRedirectUrl = `${redirectUrl}?highlight_job=${finalData.job_id}`;
                
                setTimeout(() => {
                    window.location.href = finalRedirectUrl;
                }, 1000);


            } catch (error) {
                console.error(error);
                submitButton.disabled = false;
                submitSpinner.classList.add('d-none');
                progressBar.style.width = '0%';
                progressContainer.style.display = 'none';
                statusMessage.className = 'mt-2 text-danger';
                statusMessage.textContent = `‚ùå Hiba a felt√∂lt√©skor: ${error.message}`;
                
            }
        });
    });
</script>
{% endblock %}