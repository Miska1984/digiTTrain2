{% extends 'base.html' %}
{% load static %}

{% block title %}Guggol√°s elemz√©s ‚Äì Vide√≥ felt√∂lt√©se{% endblock %}

{% block content %}
<div class="container mx-auto py-6">
    <h2 class="text-2xl font-semibold mb-4">üèãÔ∏è Guggol√°s √ârt√©kel√©s ‚Äì Vide√≥ felt√∂lt√©se</h2>
    <p class="text-muted mb-4">K√©rj√ºk, t√∂lts√∂n fel egy vide√≥t, ami **3 guggol√°si ism√©tl√©st** mutat be. A kamera legyen **oldalr√≥l** vagy **szemb≈ël** elhelyezve, hogy a teljes mozg√°startom√°ny l√°that√≥ legyen.</p>

    {# ‚ùó JAV√çTOTT: Elt√°vol√≠tva az enctype="multipart/form-data" √©s hozz√°adva a data-attrib√∫tumok #}
    <form 
        id="upload-form" 
        method="post" 
        novalidate
        data-sign-url="{% url 'diagnostics:get_signed_gcs_url' %}"
        data-redirect-url="{% url 'diagnostics:athlete_diagnostics' %}"
    >
        {% csrf_token %}
        <div class="mb-3">
            <label for="id_video" class="form-label">Vide√≥ felt√∂lt√©se</label>
            <input type="file" name="video" accept="video/mp4" class="form-control" required>
            <div class="form-text">MP4 form√°tum, a teljes mozg√°s l√°that√≥ legyen.</div>
        </div>

        <div class="mb-3">
            <label for="id_notes" class="form-label">Megjegyz√©s (opcion√°lis)</label>
            <textarea name="notes" class="form-control" rows="3"></textarea>
        </div>

        {# Felt√∂lt√©si folyamat jelz≈ëi #}
        <div id="progress-container" class="progress my-3" style="display:none;">
            <div id="upload-progress" class="progress-bar bg-success" style="width:0%">0%</div>
        </div>
        <div id="status-message" class="mt-2 text-muted"></div>

        <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-upload me-2"></i> Felt√∂lt√©s √©s elemz√©s ind√≠t√°sa
        </button>
    </form>
</div>
{% endblock %}

{# ----------------------------------------------------------- #}
{# JAVASCRIPT: GCS Felt√∂lt√©si Logika #}
{# ----------------------------------------------------------- #}
{% block extra_js %}
<script>
    // F≈ë esem√©nyfigyel≈ë az ≈±rlap elk√ºld√©s√©re
    document.getElementById('upload-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const form = e.target;
        const videoInput = form.querySelector('input[name="video"]');
        const notes = form.querySelector('textarea[name="notes"]').value;
        const submitButton = form.querySelector('button[type="submit"]');

        const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
        const videoFile = videoInput.files[0];

        const statusMessage = document.getElementById('status-message');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('upload-progress');
        
        // Dinamikus adatok a form attrib√∫tumokb√≥l
        const signUrl = form.getAttribute('data-sign-url');
        const finalJobUrl = form.action || window.location.href; 
        const redirectUrl = form.getAttribute('data-redirect-url');

        if (!videoFile) {
            statusMessage.className = 'mt-2 text-danger';
            statusMessage.textContent = '‚ùå K√©rj√ºk, v√°lasszon egy vide√≥f√°jlt a felt√∂lt√©shez.';
            return;
        }

        // El≈ëk√©sz√ºletek
        submitButton.disabled = true;
        progressContainer.style.display = 'block';
        statusMessage.className = 'mt-2 text-info';
        statusMessage.textContent = '‚è≥ 1/3: Al√°√≠rt URL ig√©nyl√©se a Google Cloud Storage-t√≥l...';

        try {
            // =========================================================
            // L√âP√âS 1: Al√°√≠rt URL ig√©nyl√©se a backendt≈ël
            // =========================================================
            const uniqueFileName = `${Date.now()}_${videoFile.name.replace(/[^a-zA-Z0-9._-]/g, '_')}`;

            const signResponse = await fetch(signUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({
                    file_name: uniqueFileName,
                    content_type: videoFile.type,
                }),
            });

            const signData = await signResponse.json();

            if (!signData.success) {
                throw new Error(signData.error || 'Hiba az al√°√≠rt URL ig√©nyl√©sekor.');
            }

            const { signed_url, file_name: gcs_object_name } = signData;
            statusMessage.textContent = '‚è≥ 2/3: Vide√≥ felt√∂lt√©se k√∂zvetlen√ºl a Google Cloud Storage-ra...';

            // =========================================================
            // L√âP√âS 2: K√∂zvetlen felt√∂lt√©s a GCS-re (PUT k√©r√©s XHR-rel a progress miatt)
            // =========================================================
            const xhr = new XMLHttpRequest();
            
            xhr.open('PUT', signed_url, true);
            // KRITIKUS: A GCS elv√°rja a Content-Type fejl√©cet
            xhr.setRequestHeader('Content-Type', videoFile.type); 

            // Progress bar friss√≠t√©se
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percent + '%';
                    progressBar.textContent = percent + '%';
                    statusMessage.textContent = `‚è≥ 2/3: Felt√∂lt√©s folyamatban: ${percent}%`;
                }
            });

            // Aszinkron felt√∂lt√©s √≠g√©retekkel
            await new Promise((resolve, reject) => {
                xhr.onload = function() {
                    // Sikeres felt√∂lt√©s 2xx st√°tuszk√≥d eset√©n
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve();
                    } else {
                        reject(new Error(`Hiba a GCS felt√∂lt√©skor. St√°tusz: ${xhr.status}. V√°lasz: ${xhr.responseText}`));
                    }
                };
                xhr.onerror = function() {
                    reject(new Error('H√°l√≥zati hiba a GCS felt√∂lt√©s sor√°n.'));
                };
                xhr.send(videoFile);
            });
            
            statusMessage.textContent = '‚úÖ 2/3: Felt√∂lt√©s sikeres. Job ind√≠t√°sa...';
            progressBar.classList.remove('bg-success');
            progressBar.classList.add('bg-primary');
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';

            // =========================================================
            // L√âP√âS 3: Job l√©trehoz√°sa a Django-ban (JSON POST)
            // =========================================================
            const finalPostResponse = await fetch(finalJobUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({
                    video_url: gcs_object_name, 
                    notes: notes,
                }),
            });

            let finalData = {}; // Kezd≈ë√©rt√©k

            // A v√°lasz feldolgoz√°sa: ellen≈ërizz√ºk a Content-Type-ot, miel≈ëtt JSON-k√©nt parse-oljuk.
            const contentType = finalPostResponse.headers.get("content-type");

            // Ha a v√°lasz sikeres (2xx) √©s a Content-Type fejl√©c tartalmazza a 'json'-t
            if (finalPostResponse.ok && contentType && contentType.includes("application/json")) {
                finalData = await finalPostResponse.json();
            } else if (finalPostResponse.ok) {
                // Ha a v√°lasz sikeres (2xx), de nem JSON-t kapunk (pl. √ºres body vagy redirect HTML),
                // felt√©telezz√ºk a sikert, hogy a kliensoldali flow tov√°bb menjen.
                console.warn('Sikeres szerverv√°lasz √©rkezett, de nem JSON form√°tumban. Felt√©telezett siker.');
                finalData = { success: true }; 
            } else {
                // St√°tusz hiba (4xx, 5xx). Olvassuk ki a v√°lasz sz√∂veg√©t, ha van.
                const errorText = await finalPostResponse.text();
                // Visszadobunk egy √©rtelmesebb hiba√ºzenetet, mint az 'Unexpected end of JSON input'
                throw new Error(`Django hiba a Job ind√≠t√°sakor. St√°tusz: ${finalPostResponse.status}. V√°lasz: ${errorText.substring(0, 100)}...`);
            }

            // Az eredeti success ellen≈ërz√©s a jav√≠tott finalData objektumon fut le.
            if (!finalData.success) {
                throw new Error(finalData.error || 'Hiba a Job l√©trehoz√°sakor/ind√≠t√°sakor (a szerver JSON-t adott, de success: false).');
            }

            // Siker eset√©n √°tir√°ny√≠t√°s
            statusMessage.className = 'mt-2 text-success';
            statusMessage.textContent = `üéâ Sikeres: Job #${finalData.job_id} elindult. √Åtir√°ny√≠t√°s...`;
            // üÜï JAV√çTOTT R√âSZ -------------------------------------
            // Job ID √°tad√°sa URL param√©terben a lista oldalnak
            const finalRedirectUrl = `${redirectUrl}?highlight_job=${finalData.job_id}`;

            // Kicsi k√©sleltet√©s a visszajelz√©s miatt, miel≈ëtt √°tir√°ny√≠tunk
            setTimeout(() => {
                window.location.href = finalRedirectUrl; // M√≥dos√≠tva!
            }, 1000);

        } catch (error) {
            console.error(error);
            submitButton.disabled = false;
            progressBar.style.width = '0%';
            progressContainer.style.display = 'none';
            statusMessage.className = 'mt-2 text-danger';
            statusMessage.textContent = `‚ùå Hiba a felt√∂lt√©skor: ${error.message}`;
            
        }
    });
</script>
{% endblock %}