<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('upload-form');
    const fileInput = uploadForm.querySelector('input[type="file"]');
    const notesInput = uploadForm.querySelector('#id_notes'); // Felt√©telezve, hogy az ID √≠gy n√©z ki
    const submitButton = document.getElementById('submit-button');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');

    const signUrl = uploadForm.getAttribute('data-sign-url');
    const redirectUrl = uploadForm.getAttribute('data-redirect-url');

    // ----------------------------------------------------
    // Seg√©df√ºggv√©ny: Felt√∂lt√©s ind√≠t√°sa √©s GCS felt√∂lt√©s
    // ----------------------------------------------------
    uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (fileInput.files.length === 0) {
            alert("K√©rj√ºk, v√°lasszon ki egy vide√≥t a felt√∂lt√©shez.");
            return;
        }
        
        const file = fileInput.files[0];

        // UI elemek friss√≠t√©se
        submitButton.disabled = true;
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        statusMessage.className = 'mt-2 text-info small';
        statusMessage.textContent = `1/2: GCS al√°√≠rt URL k√©r√©se (${file.name})...`;

        try {
            // A. 1. L√âP√âS: Al√°√≠rt URL k√©r√©se a Django-t√≥l (GCS-sign endpoint)
            const signResponse = await fetch(signUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    filename: file.name,
                    content_type: file.type
                })
            });

            if (!signResponse.ok) {
                const errorData = await signResponse.json();
                throw new Error(`Hiba az al√°√≠rt URL k√©r√©s√©ben: ${errorData.error || signResponse.statusText}`);
            }

            const signData = await signResponse.json();
            const signedUrl = signData.signed_url;
            const videoUrlInGCS = signData.public_url; // Az a teljes URL, amit a Django DB-be ment√ºnk

            statusMessage.textContent = `2/2: Vide√≥ felt√∂lt√©se Google Cloud Storage-ra...`;
            
            // B. 2. L√âP√âS: Vide√≥ felt√∂lt√©se k√∂zvetlen√ºl a GCS-re (PUT met√≥dus)
            const gcsUploadResponse = await fetch(signedUrl, {
                method: 'PUT',
                body: file,
                headers: {
                    'Content-Type': file.type
                },
                // Felt√∂lt√©s el≈ërehalad√°s√°nak k√∂vet√©se (opcion√°lis, de aj√°nlott)
                onprogress: (event) => {
                    if (event.lengthComputable) {
                        const percent = Math.round((event.loaded / event.total) * 100);
                        progressBar.style.width = percent + '%';
                        statusMessage.textContent = `2/2: Vide√≥ felt√∂lt√©se Google Cloud Storage-ra (${percent}%)...`;
                    }
                }
            });
            
            if (!gcsUploadResponse.ok) {
                 // GCS hiba, pl. jogosults√°g vagy f√°jlm√©ret
                throw new Error(`GCS Felt√∂lt√©si Hiba. St√°tusz: ${gcsUploadResponse.status} (${gcsUploadResponse.statusText})`);
            }
            
            progressBar.style.width = '100%';
            statusMessage.textContent = `‚úÖ Felt√∂lt√©s k√©sz. Job ind√≠t√°sa...`;


            // C. 3. L√âP√âS: Vissza POST a Django-hoz, a Job elind√≠t√°s√°hoz
            const finalPostResponse = await fetch(uploadForm.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    video_url: videoUrlInGCS, // Ez a GCS el√©r√©si √∫tja!
                    notes: notesInput.value
                })
            });

            if (!finalPostResponse.ok) {
                 // Django hiba (pl. valid√°ci√≥ vagy Job ment√©s)
                 const errorText = await finalPostResponse.text();
                 throw new Error(`Django hiba a Job ind√≠t√°sakor. St√°tusz: ${finalPostResponse.status}. V√°lasz: ${errorText.substring(0, 100)}...`);
            }
            
            const finalData = await finalPostResponse.json();

            if (!finalData.success) {
                throw new Error(finalData.error || 'Hiba a Job l√©trehoz√°sakor/ind√≠t√°sakor.');
            }

            // Siker eset√©n √°tir√°ny√≠t√°s
            statusMessage.className = 'mt-2 text-success';
            statusMessage.textContent = `üéâ Sikeres: Job #${finalData.job_id} elindult. √Åtir√°ny√≠t√°s...`;
            const finalRedirectUrl = `${redirectUrl}?highlight_job=${finalData.job_id}`;

            setTimeout(() => {
                window.location.href = finalRedirectUrl; 
            }, 1000);

        } catch (error) {
            console.error(error);
            submitButton.disabled = false;
            progressBar.style.width = '0%';
            progressContainer.style.display = 'none';
            statusMessage.className = 'mt-2 text-danger';
            statusMessage.textContent = `‚ùå Hiba a felt√∂lt√©skor: ${error.message}`;
            alert(`Felt√∂lt√©si hiba: ${error.message}`);
        }
    });
});
</script>