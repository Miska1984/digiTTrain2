<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('upload-form');
    // üÜï K√©t f√°jl input azonos√≠t√°sa ID alapj√°n
    const fileInputLeft = uploadForm.querySelector('#id_video_left');
    const fileInputRight = uploadForm.querySelector('#id_video_right');
    
    const notesInput = uploadForm.querySelector('#id_notes'); 
    const submitButton = document.getElementById('submit-button');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');

    const signUrl = uploadForm.getAttribute('data-sign-url');
    const redirectUrl = uploadForm.getAttribute('data-redirect-url');

    /**
     * @brief K√©rel al√°√≠rt URL-t a Django-t√≥l, √©s felt√∂lt egy f√°jlt a GCS-re.
     * @param {File} file A felt√∂ltend≈ë File objektum.
     * @param {string} fileKey A f√°jl neve a JSON payload-ban (pl. 'video_url_left').
     * @param {number} fileIndex A jelenlegi f√°jl sorsz√°ma a teljes sorban.
     * @param {number} totalFiles A felt√∂ltend≈ë f√°jlok teljes sz√°ma.
     * @returns {string} A felt√∂lt√∂tt f√°jl v√©gleges GCS URL-je.
     */
    async function uploadSingleFile(file, fileKey, fileIndex, totalFiles) {
        statusMessage.textContent = `${fileIndex}/${totalFiles}: GCS al√°√≠rt URL k√©r√©se (${file.name})...`;

        // 1. L√âP√âS: Al√°√≠rt URL k√©r√©se a Django-t√≥l
        const signResponse = await fetch(signUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                filename: file.name,
                content_type: file.type
            })
        });

        if (!signResponse.ok) {
            const errorData = await signResponse.json();
            throw new Error(`Hiba az al√°√≠rt URL k√©r√©s√©ben: ${errorData.error || signResponse.statusText}`);
        }

        const signData = await signResponse.json();
        const signedUrl = signData.signed_url;
        const videoUrlInGCS = signData.public_url;

        // 2. L√âP√âS: Vide√≥ felt√∂lt√©se k√∂zvetlen√ºl a GCS-re (PUT met√≥dus)
        statusMessage.textContent = `${fileIndex}/${totalFiles}: Vide√≥ felt√∂lt√©se GCS-re...`;

        // Itt nem tudjuk 100%-osan k√∂vetni a progresszt, mivel a fetch API nem t√°mogatja a PUT/POST progressz esem√©nyeit.
        // A teljes folyamatot friss√≠tj√ºk.
        const gcsUploadResponse = await new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('PUT', signedUrl);
            xhr.setRequestHeader('Content-Type', file.type);

            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                    // A progress bar csak a jelenlegi f√°jl felt√∂lt√©s√©t mutatja
                    const percent = Math.round((event.loaded / event.total) * 100);
                    const totalPercent = Math.round(((fileIndex - 1 + (event.loaded / event.total)) / totalFiles) * 100);
                    progressBar.style.width = totalPercent + '%';
                    statusMessage.textContent = `${fileIndex}/${totalFiles}: Felt√∂lt√©s GCS-re (${percent}%)...`;
                }
            };

            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    resolve(xhr);
                } else {
                    reject(new Error(`GCS Felt√∂lt√©si Hiba. St√°tusz: ${xhr.status} (${xhr.statusText})`));
                }
            };

            xhr.onerror = () => reject(new Error('H√°l√≥zati hiba a GCS felt√∂lt√©sekor.'));
            xhr.send(file);
        });

        progressBar.style.width = `${Math.round((fileIndex / totalFiles) * 100)}%`;
        statusMessage.textContent = `‚úÖ ${fileIndex}/${totalFiles}: ${fileKey} Felt√∂lt√©s k√©sz.`;

        return videoUrlInGCS;
    }

    // ----------------------------------------------------
    // F≈ë felt√∂lt√©si logika
    // ----------------------------------------------------
    uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // 1. Valid√°ci√≥ √©s felt√∂ltend≈ë f√°jlok el≈ëk√©sz√≠t√©se
        if (fileInputLeft.files.length === 0 || fileInputRight.files.length === 0) {
            alert("K√©rj√ºk, v√°lasszon ki vide√≥t mind a bal, mind a jobb l√°bra.");
            return;
        }

        const filesToUpload = [
            { file: fileInputLeft.files[0], key: 'video_url_left' },
            { file: fileInputRight.files[0], key: 'video_url_right' }
        ];
        
        // UI elemek inicializ√°l√°sa
        submitButton.disabled = true;
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        statusMessage.className = 'mt-2 text-info small';
        statusMessage.textContent = `Felt√∂lt√©s ind√≠t√°sa...`;

        let gcsUrls = {};
        
        try {
            // 2. Szekvenci√°lis GCS felt√∂lt√©s
            for (let i = 0; i < filesToUpload.length; i++) {
                const item = filesToUpload[i];
                gcsUrls[item.key] = await uploadSingleFile(item.file, item.key, i + 1, filesToUpload.length);
            }

            statusMessage.textContent = `‚úÖ Mindk√©t vide√≥ felt√∂ltve. Job ind√≠t√°sa...`;

            // 3. L√âP√âS: Vissza POST a Django-hoz, a Job elind√≠t√°s√°hoz (JSON-ben k√ºldve az URL-eket)
            const finalPostResponse = await fetch(uploadForm.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    video_url_left: gcsUrls.video_url_left, // üÜï Bal GCS URL
                    video_url_right: gcsUrls.video_url_right, // üÜï Jobb GCS URL
                    notes: notesInput ? notesInput.value : ''
                })
            });

            if (!finalPostResponse.ok) {
                const errorText = await finalPostResponse.text();
                throw new Error(`Django hiba a Job ind√≠t√°sakor. St√°tusz: ${finalPostResponse.status}. V√°lasz: ${errorText.substring(0, 100)}...`);
            }
            
            const finalData = await finalPostResponse.json();

            if (finalData.error) {
                 throw new Error(finalData.error);
            }

            // Siker eset√©n √°tir√°ny√≠t√°s
            statusMessage.className = 'mt-2 text-success';
            statusMessage.textContent = `üéâ Sikeres: K√©t Job elindult: #${finalData.job_ids.join(', #')} . √Åtir√°ny√≠t√°s...`;
            // √Åtir√°ny√≠t√°s az els≈ë job ID-j√©vel
            const finalRedirectUrl = `${redirectUrl}?highlight_job=${finalData.job_ids[0]}`; 

            setTimeout(() => {
                window.location.href = finalRedirectUrl; 
            }, 1000);

        } catch (error) {
            console.error(error);
            submitButton.disabled = false;
            progressBar.style.width = '0%';
            progressContainer.style.display = 'none';
            statusMessage.className = 'mt-2 text-danger';
            statusMessage.textContent = `‚ùå Hiba a felt√∂lt√©skor: ${error.message}`;
            alert(`Felt√∂lt√©si hiba: ${error.message}`);
        }
    });
});
</script>