<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('upload-form');
    // ‚úÖ Helyes keres√©s: A template-ben l√©v≈ë egyetlen input mez≈ë (name="video")
    const fileInput = uploadForm.querySelector('input[name="video"]'); 
    
    // UI elemek
    const notesInput = uploadForm.querySelector('#id_notes'); 
    const submitButton = document.getElementById('submit-button');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');

    const signUrl = uploadForm.getAttribute('data-sign-url');
    const redirectUrl = uploadForm.getAttribute('data-redirect-url');


    /**
     * @brief K√©rel al√°√≠rt URL-t a Django-t√≥l, √©s felt√∂lt egy f√°jlt a GCS-re.
     */
    async function uploadSingleFile(file, fileKey) {
        statusMessage.textContent = `GCS al√°√≠rt URL k√©r√©se (${file.name})...`;

        // 1. L√âP√âS: Al√°√≠rt URL k√©r√©se a Django-t√≥l
        const signResponse = await fetch(signUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                filename: file.name,
                content_type: file.type
            })
        });

        if (!signResponse.ok) {
            const errorData = await signResponse.json();
            throw new Error(`Hiba az al√°√≠rt URL k√©r√©s√©ben: ${errorData.error || signResponse.statusText}`);
        }

        const signData = await signResponse.json();
        const signedUrl = signData.signed_url;
        const videoUrlInGCS = signData.public_url;

        // 2. L√âP√âS: Vide√≥ felt√∂lt√©se k√∂zvetlen√ºl a GCS-re (PUT met√≥dus)
        statusMessage.textContent = `Vide√≥ felt√∂lt√©se GCS-re...`;

        const gcsUploadResponse = await new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('PUT', signedUrl);
            xhr.setRequestHeader('Content-Type', file.type);

            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                    const percent = Math.round((event.loaded / event.total) * 100);
                    progressBar.style.width = percent + '%';
                    statusMessage.textContent = `Felt√∂lt√©s GCS-re (${percent}%)...`;
                }
            };

            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    resolve(xhr);
                } else {
                    reject(new Error(`GCS Felt√∂lt√©si Hiba. St√°tusz: ${xhr.status} (${xhr.statusText})`));
                }
            };

            xhr.onerror = () => reject(new Error('H√°l√≥zati hiba a GCS felt√∂lt√©sekor.'));
            xhr.send(file);
        });

        progressBar.style.width = '100%';
        statusMessage.textContent = `‚úÖ Felt√∂lt√©s k√©sz.`;

        return videoUrlInGCS;
    }

    // ----------------------------------------------------
    // F≈ë felt√∂lt√©si logika
    // ----------------------------------------------------
    uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // 1. Valid√°ci√≥ √©s felt√∂ltend≈ë f√°jlok el≈ëk√©sz√≠t√©se
        if (!fileInput || fileInput.files.length === 0) {
            alert("K√©rj√ºk, v√°lasszon ki egy vide√≥t a felt√∂lt√©shez.");
            return;
        }

        const fileToUpload = fileInput.files[0];
        
        // UI elemek inicializ√°l√°sa
        submitButton.disabled = true;
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        statusMessage.className = 'mt-2 text-info small';
        statusMessage.textContent = `Felt√∂lt√©s ind√≠t√°sa...`;

        let gcsUrl = '';
        
        try {
            // 2. GCS felt√∂lt√©s
            gcsUrl = await uploadSingleFile(fileToUpload, 'video_url');

            statusMessage.textContent = `‚úÖ Vide√≥ felt√∂ltve. Job ind√≠t√°sa...`;

            // 3. L√âP√âS: Vissza POST a Django-hoz, a Job elind√≠t√°s√°hoz
            const finalPostResponse = await fetch(uploadForm.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    video_url: gcsUrl, 
                    notes: notesInput ? notesInput.value : ''
                })
            });

            if (!finalPostResponse.ok) {
                const errorText = await finalPostResponse.text();
                throw new Error(`Django hiba a Job ind√≠t√°sakor. St√°tusz: ${finalPostResponse.status}. V√°lasz: ${errorText.substring(0, 100)}...`);
            }
            
            const finalData = await finalPostResponse.json();

            if (finalData.error) {
                 throw new Error(finalData.error);
            }

            // Siker eset√©n √°tir√°ny√≠t√°s
            statusMessage.className = 'mt-2 text-success';
            const finalRedirectUrl = `${redirectUrl}?highlight_job=${finalData.job_id}`; 

            statusMessage.textContent = `üéâ Sikeres: Job #${finalData.job_id} elindult. √Åtir√°ny√≠t√°s...`;

            setTimeout(() => {
                window.location.href = finalRedirectUrl; 
            }, 1000);

        } catch (error) {
            console.error(error);
            submitButton.disabled = false;
            progressBar.style.width = '0%';
            progressContainer.style.display = 'none';
            statusMessage.className = 'mt-2 text-danger';
            statusMessage.textContent = `‚ùå Hiba a felt√∂lt√©skor: ${error.message}`;
            alert(`Felt√∂lt√©si hiba: ${error.message}`);
        }
    });
});
</script>