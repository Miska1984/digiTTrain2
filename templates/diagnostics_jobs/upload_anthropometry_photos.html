{% extends 'base.html' %}
{% load static %}

{% block title %}Antropometria Kalibr√°ci√≥ ‚Äì F√©nyk√©pek felt√∂lt√©se{% endblock %}

{% block content %}
<div class="container mx-auto py-6">
    <h2 class="text-2xl font-semibold mb-4">üì∑ Antropometria Kalibr√°ci√≥</h2>
    <p class="text-muted mb-4">
        A pontos test-szegmenshosszak becsl√©s√©hez k√©rj√ºk, t√∂ltse fel a <strong>szemb≈ël</strong> √©s <strong>oldalr√≥l</strong> k√©sz√ºlt f√©nyk√©peket, 
        √©s adja meg a pontos, ellen≈ërz√∂tt testmagass√°g√°t m√©terben.
    </p>

    <div class="alert alert-info" role="alert">
        <h4 class="alert-heading">F√©nyk√©pez√©si √∫tmutat√≥ (A pontos eredm√©ny√©rt)</h4>
        <ul>
            <li><strong>Testtart√°s:</strong> √Ålljon egyenesen, z√°rt l√°bakkal, karok enyh√©n el√°llva a t√∂rzst≈ël.</li>
            <li><strong>H√°tt√©r:</strong> Egysz√≠n≈±, kontrasztos h√°tt√©r (pl. feh√©r fal) a jobb detekt√°l√°s √©rdek√©ben.</li>
            <li><strong>L√°bak:</strong> Meztelen l√°b vagy zokni (cip≈ë n√©lk√ºl!).</li>
            <li><strong>Ruh√°zat:</strong> Sz≈±k ruh√°zat (pl. sportmelltart√≥, r√∂vidnadr√°g), hogy a kont√∫rok l√°that√≥ak legyenek.</li>
        </ul>
    </div>

    <form 
        id="upload-form" 
        method="post" 
        novalidate
        data-sign-url="{% url 'diagnostics:get_signed_gcs_url' %}"
        data-job-url="{% url 'diagnostics_jobs:calibrate_anthropometry_with_photos' %}"
        data-redirect-url="{% url 'diagnostics:athlete_diagnostics' %}"
    >
        {% csrf_token %}
        
        <div class="mb-3">
            <label for="id_height_m" class="form-label fw-bold">Testmagass√°g (m√©terben)</label>
            <input 
                type="number" 
                step="0.01" 
                min="0.5" 
                max="2.5" 
                name="user_stated_height_m" 
                id="id_height_m" 
                class="form-control" 
                placeholder="Pl. 1.75" 
                required
            >
            <div class="form-text">Adja meg a pontos testmagass√°g√°t m√©terben (pl. 1.75).</div>
        </div>
        
        <div class="mb-3">
            <label for="id_front_photo" class="form-label fw-bold">1. F√©nyk√©p (Szemb≈ël)</label>
            <input 
                type="file" 
                name="front_photo" 
                accept="image/jpeg,image/png" 
                class="form-control" 
                id="id_front_photo"
                required
            >
            <div class="form-text">JPEG vagy PNG form√°tum.</div>
            <div id="preview-front" class="mt-2"></div>
        </div>

        <div class="mb-3">
            <label for="id_side_photo" class="form-label fw-bold">2. F√©nyk√©p (Oldalr√≥l)</label>
            <input 
                type="file" 
                name="side_photo" 
                accept="image/jpeg,image/png" 
                class="form-control" 
                id="id_side_photo"
                required
            >
            <div class="form-text">JPEG vagy PNG form√°tum.</div>
            <div id="preview-side" class="mt-2"></div>
        </div>

        <button 
            type="submit" 
            id="submit-button" 
            class="btn btn-primary w-100 mt-4"
        >
            üöÄ Felt√∂lt√©s √©s Kalibr√°ci√≥ ind√≠t√°sa
        </button>

        <div id="progress-container" class="mt-3" style="display: none;">
            <div class="progress" role="progressbar" aria-label="Felt√∂lt√©s" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
            </div>
        </div>
        <p id="status-message" class="mt-2 text-info"></p>

    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('upload-form');
    const submitButton = document.getElementById('submit-button');
    const progressBar = document.getElementById('progress-bar');
    const progressContainer = document.getElementById('progress-container');
    const statusMessage = document.getElementById('status-message');
    
    const previewFront = document.getElementById('preview-front');
    const previewSide = document.getElementById('preview-side');
    
    // Adat attrib√∫tumok
    const SIGN_URL = form.dataset.signUrl;
    const JOB_URL = form.dataset.jobUrl;
    const REDIRECT_URL = form.dataset.redirectUrl;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // üí° SEG√âDF√úGGV√âNY: el≈ën√©zet megjelen√≠t√©se
    function showPreview(file, container) {
        const reader = new FileReader();
        reader.onload = function(e) {
            container.innerHTML = `
                <img src="${e.target.result}" 
                     alt="El≈ën√©zet" 
                     class="rounded shadow-sm border"
                     style="max-width: 240px; max-height: 320px; object-fit: cover;">
            `;
        };
        reader.readAsDataURL(file);
    }

    // F√°jlv√°laszt√°s esem√©nyek
    document.getElementById('id_front_photo').addEventListener('change', e => {
        if (e.target.files[0]) showPreview(e.target.files[0], previewFront);
    });
    document.getElementById('id_side_photo').addEventListener('change', e => {
        if (e.target.files[0]) showPreview(e.target.files[0], previewSide);
    });
    
    // üí° SEG√âDF√úGGV√âNY: F√°jl felt√∂lt√©se GCS-re
    async function _uploadFileToGCS(file, fileType) {
        statusMessage.textContent = `‚è≥ Lek√©rem a GCS felt√∂lt√©si URL-t (${fileType})...`;
        
        const signResponse = await fetch(SIGN_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({
                file_name: file.name,
                content_type: file.type,
                is_photo: true, 
                job_type: 'ANTHROPOMETRY_CALIBRATION',
                photo_type: fileType 
            }),
        });
        
        if (!signResponse.ok) {
            const errorData = await signResponse.json();
            throw new Error(`Nem siker√ºlt al√°√≠rt URL-t k√©rni: ${errorData.error || signResponse.statusText}`);
        }
        
        const signData = await signResponse.json();
        // ‚úÖ FIX: a backend `file_name` mez≈ët ad vissza
        const signed_url = signData.signed_url;
        const gcs_object_name = signData.file_name;

        statusMessage.textContent = `üì§ Felt√∂lt√∂m a f√°jlt: ${file.name} (${fileType})...`;
        
        const gcsUploadResponse = await fetch(signed_url, {
            method: 'PUT',
            headers: {
                'Content-Type': file.type, 
                'Content-Length': file.size,
            },
            body: file,
        });

        if (!gcsUploadResponse.ok) {
            const errorText = await gcsUploadResponse.text();
            throw new Error(`GCS felt√∂lt√©si hiba. St√°tusz: ${gcsUploadResponse.status}. V√°lasz: ${errorText.substring(0, 100)}...`);
        }

        statusMessage.textContent = `‚úÖ Sikeres felt√∂lt√©s: ${file.name} (${fileType}).`;
        return gcs_object_name;
    }

    // üëë F≈ê SUBMIT KEZEL≈ê
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const frontPhotoFile = document.getElementById('id_front_photo').files[0];
        const sidePhotoFile = document.getElementById('id_side_photo').files[0];
        const statedHeight = document.getElementById('id_height_m').value;

        if (!frontPhotoFile || !sidePhotoFile || !statedHeight) {
            statusMessage.className = 'mt-2 text-danger';
            statusMessage.textContent = '‚ùå K√©rj√ºk, t√∂ltse ki az √∂sszes mez≈ët!';
            return;
        }

        submitButton.disabled = true;
        progressContainer.style.display = 'block';
        progressBar.style.width = '10%'; 
        statusMessage.className = 'mt-2 text-info';
        statusMessage.textContent = 'Ind√≠t√°s: K√©pek el≈ëk√©sz√≠t√©se √©s felt√∂lt√©se...';

        try {
            progressBar.style.width = '20%';
            const frontGcsKey = await _uploadFileToGCS(frontPhotoFile, 'szemb≈ël');
            
            progressBar.style.width = '50%';
            const sideGcsKey = await _uploadFileToGCS(sidePhotoFile, 'oldalr√≥l');
            
            progressBar.style.width = '80%';
            statusMessage.textContent = 'üöÄ Kalibr√°ci√≥s Job ind√≠t√°sa...';

            console.log("DEBUG: frontGcsKey:", frontGcsKey);
            console.log("DEBUG: sideGcsKey:", sideGcsKey);
            
            const finalPostResponse = await fetch(JOB_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({
                    front_photo_url: frontGcsKey, 
                    side_photo_url: sideGcsKey,
                    user_stated_height_m: statedHeight,
                    job_type: 'ANTHROPOMETRY_CALIBRATION' 
                }),
            });

            const finalData = await finalPostResponse.json();

            if (!finalData.success) {
                throw new Error(finalData.error || 'Hiba a Job l√©trehoz√°sakor/ind√≠t√°sakor.');
            }

            progressBar.style.width = '100%';
            statusMessage.className = 'mt-2 text-success';
            statusMessage.textContent = `üéâ Sikeres: Kalibr√°ci√≥s Job #${finalData.job_id} elindult. √Åtir√°ny√≠t√°s...`;
            
            setTimeout(() => {
                window.location.href = `${REDIRECT_URL}?highlight_job=${finalData.job_id}`;
            }, 1500);

        } catch (error) {
            console.error(error);
            submitButton.disabled = false;
            progressBar.style.width = '0%';
            progressContainer.style.display = 'none';
            statusMessage.className = 'mt-2 text-danger';
            statusMessage.textContent = `‚ùå Hiba a felt√∂lt√©skor: ${error.message}`;
        }
    });
});
</script>
{% endblock %}
