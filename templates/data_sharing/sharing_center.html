{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4"><i class="fas fa-share-alt"></i> {{ page_title }}</h2>

    {% if not matrices_data %}
        <div class="alert alert-info">
            Nincs megjeleníthető adatmegosztási mátrix. Valószínűleg még nem tartozol egyetlen klubhoz/sportághoz sem, vagy nincsenek jóváhagyott edzőid.
        </div>
    {% endif %}

    {% for data in matrices_data %}
        <div class="card mb-5 shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-user"></i> {{ data.owner_name }} adatai
                </h4>
                {% if data.is_minor %}
                    <span class="badge bg-warning text-dark">Kiskorú sportoló</span>
                {% endif %}
            </div>
            
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle border">
                        <thead class="table-light">
                            <tr>
                                <th style="min-width: 200px;">Személy / Szerepkör</th>
                                {% for cell in data.matrix_rows.0.cells %}
                                    <th class="text-center">{{ cell.display_name }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data.matrix_rows %}
                                <tr>
                                    <td>
                                        <strong>{{ row.target_user_name }}</strong><br>
                                        <small class="text-muted">{{ row.target_role_name }} - {{ row.target_club_name }}</small>
                                    </td>
                                    
                                    {% for cell in row.cells %}
                                        <td class="text-center">
                                            <div class="d-flex flex-column align-items-center">
                                                <div class="form-check form-switch p-0 m-0">
                                                    <input class="form-check-input permission-toggle" 
                                                           type="checkbox"
                                                           style="cursor: pointer; width: 3em; height: 1.5em;"
                                                           data-owner-id="{{ data.data_owner.id }}"
                                                           data-target-id="{{ row.target_user_id }}"
                                                           data-target-role-id="{{ row.target_role_id }}"
                                                           data-app="{{ cell.app_name }}"
                                                           data-table="{{ cell.table_name }}"
                                                           {% if data.is_parent_managing %}
                                                               {% if cell.parent_consent %}checked{% endif %}
                                                           {% else %}
                                                               {% if cell.athlete_consent %}checked{% endif %}
                                                           {% endif %}>
                                                </div>

                                                <div class="mt-1">
                                                    {% if cell.enabled %}
                                                        <span class="badge bg-success" id="status-{{ data.data_owner.id }}-{{ row.target_role_id }}-{{ cell.table_name }}">Aktív</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary" id="status-{{ data.data_owner.id }}-{{ row.target_role_id }}-{{ cell.table_name }}">Inaktív</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer text-muted small">
                <i class="fas fa-info-circle"></i> 
                {% if data.is_minor %}
                    Kiskorúaknál az adatmegosztás csak akkor válik <strong>Aktívvá</strong>, ha a sportoló és a szülő is jóváhagyja, valamint a sportoló engedélyt adott a szülőnek.
                {% else %}
                    Felnőtteknél a sportoló jóváhagyása azonnal aktiválja az adatmegosztást.
                {% endif %}
            </div>
        </div>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggles = document.querySelectorAll('.permission-toggle');

    toggles.forEach(toggle => {
        toggle.addEventListener('change', function() {
            const formData = new FormData();
            formData.append('data_owner_id', this.dataset.ownerId);
            formData.append('target_user_id', this.dataset.targetId);
            formData.append('target_role_id', this.dataset.targetRoleId);
            formData.append('app_name', this.dataset.app);
            formData.append('table_name', this.dataset.table);

            const statusBadge = document.getElementById(`status-${this.dataset.ownerId}-${this.dataset.targetRoleId}-${this.dataset.table}`);

            fetch("{% url 'data_sharing:toggle_permission' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Frissítjük a státusz jelzőt (Badge)
                    if (data.enabled) {
                        statusBadge.className = 'badge bg-success';
                        statusBadge.innerText = 'Aktív';
                    } else {
                        statusBadge.className = 'badge bg-secondary';
                        statusBadge.innerText = 'Inaktív';
                    }
                } else {
                    alert('Hiba történt: ' + data.error);
                    this.checked = !this.checked; // Visszaállítjuk a kapcsolót hiba esetén
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.checked = !this.checked;
            });
        });
    });
});
</script>

<style>
    .table th { vertical-align: middle; font-size: 0.85rem; }
    .form-check-input:checked { background-color: #0d6efd; border-color: #0d6efd; }
    .badge { font-size: 0.7rem; }
</style>
{% endblock %}