{% extends "base.html" %}
{% block content %}

<style>
/* ===== CHART KONTAINER – MOBIL FIRST ===== */
.chart-container {
    position: relative;
    width: 100%;
    height: 220px; /* mobil */
}

@media (min-width: 768px) {
    .chart-container {
        height: 300px; /* tablet */
    }
}

@media (min-width: 1200px) {
    .chart-container {
        height: 340px; /* desktop */
    }
}
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold">
            <i class="bi bi-person-circle me-2 text-primary"></i>{{ athlete_display_name }}
        </h1>
        <a href="{% url 'data_sharing:parent_dashboard' %}" class="btn btn-outline-secondary btn-sm">
            Vissza
        </a>
    </div>

    <!-- ================= AI MODULOK ================= -->
    <div class="row mb-5">
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm h-100 border-0 bg-light p-3">
                <h5 class="fw-bold text-primary border-bottom pb-2 mb-3">
                    <i class="bi bi-robot me-2"></i>Ditta AI Edzettségi Szint
                </h5>
                {% if 'UserFeatureSnapshot' in permissions %}
                    {% include 'data_sharing/partials/_ml_engine_module.html' %}
                {% else %}
                    <p class="text-muted small">Nincs megosztva AI állapot.</p>
                {% endif %}
            </div>
        </div>

        <div class="col-md-6 mb-3">
            <div class="card shadow-sm h-100 border-0 bg-light p-3">
                <h5 class="fw-bold text-info border-bottom pb-2 mb-3">
                    <i class="bi bi-camera-reels me-2"></i>AI Videó Diagnosztika
                </h5>
                {% if 'DiagnosticJob' in permissions %}
                    {% include 'data_sharing/partials/_diagnostics_module.html' %}
                {% else %}
                    <p class="text-muted small">Nincs megosztva videóelemzés.</p>
                {% endif %}
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-12">
                <h4 class="mb-4 fw-bold border-start border-4 border-secondary ps-3">Edzésnapló és Jelenlét</h4>
                <div class="card shadow-sm border-0 p-3">
                    {% if 'Attendance' in permissions %}
                        {% include 'data_sharing/partials/_training_log_module.html' %}
                    {% else %}
                        <div class="alert alert-warning">A jelenléti adatok nem elérhetőek.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ================= BIOMETRIA ================= -->
    <h4 class="mb-4 fw-bold border-start border-4 border-primary ps-3">
        Biometrikus Elemzések
    </h4>

    <!-- TESTSÚLY -->
    <div class="card shadow-sm mb-5 border-0">
        <div class="card-header bg-primary text-white fw-bold">
            Testsúly Trend
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="weightChart"></canvas>
            </div>
            <div class="mt-3 p-3 bg-light rounded">
                {{ weight_feedback|safe }}
            </div>
        </div>
    </div>

    <!-- HRV -->
    <div class="card shadow-sm mb-5 border-0">
        <div class="card-header bg-success text-white fw-bold">
            HRV és Regeneráció
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="hrvSleepChart"></canvas>
            </div>
            <div class="mt-3 p-3 bg-light rounded">
                {{ hrv_sleep_feedback|safe }}
            </div>
        </div>
    </div>

    <!-- MAROKERŐ -->
    <div class="card shadow-sm mb-5 border-0">
        <div class="card-header bg-warning text-dark fw-bold">
            Marokerő és Edzésintenzitás
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="gripIntensityChart"></canvas>
            </div>
            <div class="mt-3 p-3 bg-light rounded">
                {{ grip_timing_feedback|safe }}
            </div>
        </div>
    </div>

    <!-- FUTÁS -->
    <div class="card shadow-sm mb-5 border-0">
        <div class="card-header bg-danger text-white fw-bold">
            Futóteljesítmény Elemzés
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="runningChart"></canvas>
            </div>
            <div class="mt-3 p-3 bg-light rounded">
                {{ running_feedback|safe }}
            </div>
        </div>
    </div>
</div>

<!-- ================= CHART.JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function safeParse(dataStr) {
    try {
        return JSON.parse(dataStr.replace(/&quot;/g, '"'));
    } catch {
        return { labels: [] };
    }
}

const weightData = safeParse('{{ weight_chart_data_json|safe }}');
const hrvData = safeParse('{{ hrv_sleep_chart_data_json|safe }}');
const gripData = safeParse('{{ grip_intensity_chart_data_json|safe }}');
const runningData = safeParse('{{ running_chart_data_json|safe }}');

const baseOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: { position: 'top' }
    }
};

// Testsúly
if (weightData.labels?.length) {
    new Chart(weightChart, {
        type: 'line',
        data: {
            labels: weightData.labels,
            datasets: [{
                label: 'Súly (kg)',
                data: weightData.weights,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13,110,253,0.1)',
                fill: true,
                tension: 0.3
            }]
        },
        options: baseOptions
    });
}

// HRV
if (hrvData.labels?.length) {
    new Chart(hrvSleepChart, {
        type: 'line',
        data: {
            labels: hrvData.labels,
            datasets: [{
                label: 'HRV (ms)',
                data: hrvData.hrv_data,
                borderColor: '#198754',
                tension: 0.4
            }]
        },
        options: baseOptions
    });
}

// Marokerő
if (gripData.labels?.length) {
    new Chart(gripIntensityChart, {
        data: {
            labels: gripData.labels,
            datasets: [
                {
                    type: 'bar',
                    label: 'RPE',
                    data: gripData.intensity_data,
                    backgroundColor: 'rgba(255,193,7,0.5)',
                    yAxisID: 'y_rpe'
                },
                {
                    type: 'line',
                    label: 'Jobb kéz (kg)',
                    data: gripData.right_grip_data,
                    borderColor: '#dc3545',
                    yAxisID: 'y_grip'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y_rpe: { min: 0, max: 10, position: 'left' },
                y_grip: { position: 'right' }
            }
        }
    });
}

// Futás
if (runningData.labels?.length) {
    new Chart(runningChart, {
        type: 'line',
        data: {
            labels: runningData.labels,
            datasets: [{
                label: 'Tempó (mp/km)',
                data: runningData.pace_data,
                borderColor: '#dc3545'
            }]
        },
        options: {
            ...baseOptions,
            scales: { y: { reverse: true } }
        }
    });
}
</script>

{% endblock %}
