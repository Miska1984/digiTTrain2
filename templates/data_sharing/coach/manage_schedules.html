{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block content %}

<div class="row">
    <div class="col-12">
        <h2 class="mb-4">Edzésrend & Szünetek Kezelése</h2>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Ismétlődő Edzésrendek</h4>
            <a href="{% url 'data_sharing:add_schedule' %}" class="btn btn-success"><i class="fas fa-plus-circle"></i> Új Edzésrend</a>
        </div>
        
        {% for item in schedules %}
        <div class="card mb-3"> 
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    {{ item.schedule.name }}
                    <small class="text-muted">({{ item.schedule.club.short_name }} / {{ item.schedule.sport.name }})</small>
                </h5>
            </div>
            <div class="card-body p-3">
                
                <p class="text-muted small mb-1">
                    <i class="fas fa-clock"></i> Időpont: {{ item.schedule.start_time|date:"H:i" }} - {{ item.schedule.end_time|date:"H:i" }}
                </p>
                <p class="text-muted small mb-3">
                    <i class="fas fa-user-tie"></i> Felelős Edző: <strong>{{ item.full_coach_name }}</strong>
                </p>
                
                <h6 class="mt-3 text-secondary border-top pt-2">Következő 10 alkalom:</h6>
                <ul class="list-group list-group-flush small">
                    {% for session in item.next_sessions %}
                        {% if session.is_absence %}
                            <li class="list-group-item list-group-item-danger d-flex justify-content-between align-items-center p-2">
                                <div class="font-weight-bold">
                                    <i class="fas fa-calendar-times"></i> {{ session.date|date:"Y.m.d. (l)" }}
                                </div>
                                <span class="badge badge-danger badge-pill">SZÜNET: {{ session.absence_reason }}</span>
                            </li>
                        {% else %}
                            {# A list item osztályát is módosítjuk a kiemeléshez, ha elmulasztott #}
                            <li class="list-group-item d-flex justify-content-between align-items-center p-2 {% if session.is_missed %}list-group-item-warning{% endif %}">
                                
                                <div class="font-weight-bold">
                                    {# STÁTUSZ JELZÉS #}
                                    {% if session.is_recorded %}
                                        <i class="fas fa-check-circle text-success mr-1" title="Jelenlét rögzítve!"></i>
                                    {% elif session.is_missed %}
                                        <i class="fas fa-exclamation-triangle text-warning mr-1" title="Elmulasztott jelenlét rögzítés!"></i>
                                    {% else %}
                                        <i class="fas fa-calendar-check text-muted mr-1"></i>
                                    {% endif %}
                                    
                                    {# LINK A JELENLÉTI ÍVRE #}
                                    <a href="{% url 'data_sharing:record_attendance' schedule_pk=item.schedule.pk session_date=session.date|date:'Y-m-d' %}" 
                                    class="btn btn-link p-0 text-dark" 
                                    title="Jelenlét rögzítése erre a napra">
                                        {{ session.date|date:"Y.m.d. (l)" }}
                                    </a>
                                </div>
                                
                                {# JELENLÉTI ÍV GOMB #}
                                <a href="{% url 'data_sharing:record_attendance' schedule_pk=item.schedule.pk session_date=session.date|date:'Y-m-d' %}" 
                                    class="btn btn-sm {% if session.is_recorded %}btn-success{% else %}btn-outline-secondary{% endif %} py-0" 
                                    title="Jelenléti ív">
                                    <i class="fas fa-clipboard-list"></i>
                                </a>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
            <div class="card-footer d-flex justify-content-end">
                <a href="{% url 'data_sharing:edit_schedule' pk=item.schedule.pk %}" class="btn btn-sm btn-outline-primary mr-2"><i class="fas fa-pencil-alt"></i> Módosít</a>
                <a href="{% url 'data_sharing:delete_schedule' pk=item.schedule.pk %}" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i> Töröl</a>
            </div>
        </div>
        {% empty %}
            <p class="mt-3 alert alert-info">Jelenleg nincsenek ismétlődő edzésrendek a hozzád rendelt klubokban/sportágakban.</p>
        {% endfor %}
    </div>

    <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Szünetek / Leállások</h4>
             <a href="{% url 'data_sharing:add_absence' %}" class="btn btn-warning"><i class="fas fa-plus-circle"></i> Új Szünet</a>
        </div>
        
        {% for absence in absences %}
        <div class="card mb-3 border-left-warning">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="pr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            {% if absence.club %}
                                {{ absence.club.short_name }}
                            {% else %}
                                GLOBÁLIS SZÜNET
                            {% endif %}
                        </div>
                        <div class="font-weight-bold text-gray-800">{{ absence.name }}</div>
                        <p class="text-muted small mb-0">
                            <i class="fas fa-calendar-alt"></i> Dátum: {{ absence.start_date|date:"Y.m.d." }} - {{ absence.end_date|date:"Y.m.d." }}
                        </p>
                    </div>
                    
                    <div class="ml-auto d-flex flex-shrink-0">
                        <a href="{% url 'data_sharing:edit_absence' pk=absence.pk %}" class="btn btn-sm btn-link text-secondary mr-1" title="Módosítás"><i class="fas fa-pencil-alt"></i></a>
                        <a href="{% url 'data_sharing:delete_absence' pk=absence.pk %}" class="btn btn-sm btn-link text-danger" title="Törlés"><i class="fas fa-trash"></i></a>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
            <p class="mt-3 alert alert-info">Nincsenek beállított edzésszünetek.</p>
        {% endfor %}
    </div>
</div>

{% endblock %}