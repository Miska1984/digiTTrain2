{% if show_ditta %}
<div id="ditta-wrapper" class="fixed-bottom end-0 m-4" style="z-index: 1050;">
    <button id="ditta-toggle" class="btn btn-primary rounded-circle shadow-lg p-3">
        <i class="fas fa-robot fa-2x"></i>
    </button>

    <div id="ditta-window" class="card shadow-lg d-none" style="width: 350px; height: 450px;">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <span><i class="fas fa-comment-dots me-2"></i>Ditta - {% if has_ml_access %}Adat-elmező{% else %}Szemelmi Asszisztens{% endif %}</span>
            <button type="button" class="btn-close btn-close-white" id="ditta-close"></button>
        </div>
        
        <div class="card-body overflow-auto" id="ditta-chat-content" style="height: 320px;">
            <div class="ditta-message assistant bg-light p-2 rounded mb-2">
                {{ welcome_message|safe }}
            </div>
            {% if not has_ml_access and app_context == 'ml_engine' %}
            <div class="alert alert-warning small">
                Szeretnél mélyebb elemzést? Fizess elő az <strong>ML_Access</strong> csomagra!
            </div>
            {% endif %}
        </div>

        <div class="card-footer p-0">
            <div class="input-group p-2 border-top">
                <input type="text" id="ditta-user-input" class="form-control" placeholder="Írj vagy diktálj...">
                <button class="btn btn-outline-secondary" type="button" id="ditta-mic">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="btn btn-primary" type="button" id="ditta-send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .ditta-message { max-width: 85%; word-wrap: break-word; font-size: 0.9rem; position: relative; }
    .ditta-message.user { margin-left: auto; }
    
    .typing { display: flex; align-items: center; gap: 3px; padding: 5px 0; }
    .typing span {
        width: 6px; height: 6px;
        background-color: #0d6efd;
        border-radius: 50%;
        animation: blink 1.4s infinite both;
    }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
        0%, 80%, 100% { opacity: 0; }
        40% { opacity: 1; }
    }
</style>

<script>
    (function() {
        const dittaToggle = document.getElementById('ditta-toggle');
        const dittaWindow = document.getElementById('ditta-window');
        const dittaClose = document.getElementById('ditta-close');
        const dittaInput = document.getElementById('ditta-user-input');
        const dittaSend = document.getElementById('ditta-send');
        const dittaMic = document.getElementById('ditta-mic'); 
        const chatContent = document.getElementById('ditta-chat-content');

        // Segédfüggvény a dashboard chat szinkronizálásához
        function syncToDashboard(query, response = null) {
            const dashboardBox = document.getElementById('ditta-chat-box');
            if (!dashboardBox) return;

            if (query && !response) {
                dashboardBox.innerHTML += `<div class="user-msg small bg-primary text-white p-2 rounded shadow-sm mb-2 text-end">${query}</div>`;
            } else if (response) {
                dashboardBox.innerHTML += `<div class="ditta-msg small bg-white p-2 rounded shadow-sm mb-2 border-start border-info border-4">${response}</div>`;
            }
            dashboardBox.scrollTop = dashboardBox.scrollHeight;
        }

        dittaToggle.onclick = () => dittaWindow.classList.toggle('d-none');
        dittaClose.onclick = () => dittaWindow.classList.add('d-none');

        // --- DIKTÁLÁS ---
        const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (Recognition) {
            const recognition = new Recognition();
            recognition.lang = 'hu-HU';
            recognition.onstart = () => {
                dittaMic.classList.replace('btn-outline-secondary', 'btn-danger');
                dittaInput.placeholder = "Hallgatlak...";
            };
            recognition.onresult = (event) => { dittaInput.value = event.results[0][0].transcript; };
            recognition.onend = () => {
                dittaMic.classList.replace('btn-danger', 'btn-outline-secondary');
                dittaInput.placeholder = "Írj vagy diktálj...";
            };
            dittaMic.onclick = () => recognition.start();
        }

        // --- BESZÉD ---
        window.speakDitta = function(text, btnElement) {
            window.speechSynthesis.cancel();
            let cleanText = text.replace(/\*\*/g, '').replace(/\*/g, '').replace(/#/g, '').replace(/<[^>]*>?/gm, '');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'hu-HU';
            if (btnElement) {
                const originalIcon = btnElement.innerHTML;
                btnElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                utterance.onend = () => { btnElement.innerHTML = originalIcon; };
            }
            window.speechSynthesis.speak(utterance);
        };

        // --- ÜZENETKÜLDÉS ---
        async function sendMessage() {
            const query = dittaInput.value.trim();
            if (!query) return;

            // 1. Megjelenítés a widgetben
            chatContent.innerHTML += `<div class="ditta-message user text-end bg-primary text-white p-2 rounded mb-2">${query}</div>`;
            
            // 2. Szinkronizálás a Dashboarddal (ha létezik az oldalon)
            syncToDashboard(query);

            dittaInput.value = '';
            const loaderId = 'loader-' + Date.now();
            chatContent.innerHTML += `<div id="${loaderId}" class="ditta-message assistant bg-light p-2 rounded mb-2"><div class="typing"><span></span><span></span><span></span></div></div>`;
            chatContent.scrollTop = chatContent.scrollHeight;

            try {
                const response = await fetch("{% url 'ml_engine:ditta_chat_api' %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ query: query, app_context: "{{ app_context }}" })
                });
                const data = await response.json();
                
                const loader = document.getElementById(loaderId);
                if (loader) loader.remove();

                const safeText = data.response.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const messageHtml = `
                    <div class="ditta-message assistant bg-light p-2 rounded mb-2">
                        <div class="message-text">${data.response}</div>
                        <div class="text-end mt-1">
                            <button class="btn btn-sm btn-light border py-0 px-2 text-muted" onclick="window.speakDitta('${safeText}', this)">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    </div>`;
                
                chatContent.innerHTML += messageHtml;
                
                // 3. Válasz szinkronizálása a Dashboarddal
                syncToDashboard(null, data.response);

            } catch (error) {
                const loader = document.getElementById(loaderId);
                if (loader) loader.remove();
                chatContent.innerHTML += `<div class="alert alert-danger p-2 small">Hiba történt.</div>`;
            }
            chatContent.scrollTop = chatContent.scrollHeight;
        }

        dittaSend.onclick = sendMessage;
        dittaInput.onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };
    })();
</script>
{% endif %}