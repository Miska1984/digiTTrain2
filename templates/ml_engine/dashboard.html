{% extends 'base.html' %}
{% block title %}Teljes√≠tm√©ny Dashboard{% endblock %}

{% block content %}
<h1 class="mb-4 text-primary"><i class="fas fa-chart-line me-2"></i> Teljes√≠tm√©ny Dashboard</h1>

<div class="alert alert-info">{{ prediction_status|safe }}</div>

<!-- Formaindex k√°rty√°k -->
<div class="row">
  <div class="col-md-6 mb-3">
    <div class="card shadow border-success">
      <div class="card-body text-center">
        <h5>Aktu√°lis Formaindex</h5>
        <h2 class="text-success fw-bold">{{ current_form_index }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="card shadow border-danger">
      <div class="card-body text-center">
        <h5>V√°rhat√≥ Formaindex</h5>
        <h2 class="text-danger fw-bold">{{ predicted_form_index }}</h2>
      </div>
    </div>
  </div>
</div>

{% if latest_prediction %}
<div class="card shadow mb-4" style="border-left: 5px solid #007bff; background-color: #f8fbff;">
    <div class="card-body">
        <div class="d-flex align-items-center mb-3">
            <div class="flex-shrink-0">
                <i class="fas fa-robot text-primary" style="font-size: 2rem;"></i>
            </div>
            <div class="ms-3">
                <h5 class="card-title mb-0 text-primary fw-bold">DigitTrain AI Coach Tan√°csa</h5>
                <small class="text-muted">Elemz√©s id≈ëpontja: {{ latest_prediction.predicted_at|date:"Y.m.d. H:i" }}</small>
            </div>
        </div>
        <hr>
        <div class="card-text text-dark" style="font-size: 1.1rem; line-height: 1.7;">
            {{ latest_prediction.ai_advice|linebreaks }}
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-light border shadow-sm d-flex align-items-center">
    <i class="fas fa-spinner fa-spin me-3 text-primary"></i>
    <span>Az AI Coach √©ppen az adataidat elemzi a felh≈ëben... Friss√≠ts az oldalon p√°r m√°sodperc m√∫lva!</span>
</div>
{% endif %}

<!-- √öj szakasz: Forma√©rt√©kel√©s -->
<div class="card shadow mt-4">
  <div class="card-header bg-light">
    <h5 class="mb-0"><i class="fas fa-dumbbell me-2"></i>Forma√©rt√©kel√©s</h5>
  </div>
  <div class="card-body">
    <p><strong>Aktu√°lis √©rt√©kel√©s:</strong>
      <span style="color: {{ evaluation_color }};">{{ evaluation_text }}</span>
    </p>
    <p><strong>V√°rhat√≥ trend:</strong> {{ trend_message|safe }}</p>

    <hr>
    <h6 class="text-secondary mb-2">Formaindex kateg√≥ri√°k</h6>
    <div class="table-responsive">
      <table class="table table-bordered text-center align-middle">
        <thead class="table-light">
          <tr>
            <th>Szint</th>
            <th>Formaindex tartom√°ny</th>
            <th>Le√≠r√°s</th>
          </tr>
        </thead>
        <tbody>
          <tr class="text-danger fw-semibold">
            <td>Gyenge</td>
            <td>0 ‚Äì 20</td>
            <td>Regener√°ci√≥ javasolt</td>
          </tr>
          <tr class="text-warning fw-semibold">
            <td>K√∂zepes</td>
            <td>20 ‚Äì 30</td>
            <td>Fejl≈ëd≈ë √°llapot</td>
          </tr>
          <tr class="text-success fw-semibold">
            <td>J√≥</td>
            <td>30 ‚Äì 40</td>
            <td>Fenntart√≥ szint</td>
          </tr>
          <tr class="text-primary fw-semibold">
            <td>Kiemelked≈ë</td>
            <td>40+</td>
            <td>Teljes√≠tm√©ny cs√∫cson</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- S√©r√ºl√©skock√°zat blokk -->
<div class="card shadow mt-4 border-warning">
  <div class="card-header bg-light">
    <h5 class="mb-0">
      <i class="fas fa-exclamation-triangle me-2 text-warning"></i>S√©r√ºl√©skock√°zat
    </h5>
  </div>
  <div class="card-body text-center">
    {% if injury_risk %}
      <h2 class="{% if injury_risk|floatformat:1 > 70 %}text-danger{% elif injury_risk|floatformat:1 > 40 %}text-warning{% else %}text-success{% endif %}">
        {{ injury_risk }}%
      </h2>
      <p class="mt-2">
        {% if injury_risk|floatformat:1 > 70 %}
          ‚ö†Ô∏è Magas kock√°zat ‚Äì regener√°ci√≥ sz√ºks√©ges
        {% elif injury_risk|floatformat:1 > 40 %}
          ‚ö†Ô∏è K√∂zepes kock√°zat ‚Äì figyelj a pihen√©sre
        {% else %}
          ‚úÖ Alacsony kock√°zat ‚Äì megfelel≈ë regener√°ci√≥
        {% endif %}
      </p>
    {% else %}
      <p class="text-muted">Nincs el√©g adat a becsl√©shez.</p>
    {% endif %}
  </div>
</div>


<!-- üü© √öj: Statisztikai √∂sszegz√©s -->
<div class="row mt-4">
  <div class="col-md-4 mb-3">
    <div class="card shadow-sm border-success text-center p-3">
      <h6 class="text-muted">√Åtlagos formaindex</h6>
      <h3 class="text-success fw-bold">{{ avg_form }}</h3>
    </div>
  </div>
  <div class="col-md-4 mb-3">
    <div class="card shadow-sm border-primary text-center p-3">
      <h6 class="text-muted">Legjobb formaindex</h6>
      <h3 class="text-primary fw-bold">{{ best_form }}</h3>
    </div>
  </div>
  <div class="col-md-4 mb-3">
    <div class="card shadow-sm border-danger text-center p-3">
      <h6 class="text-muted">Legrosszabb formaindex</h6>
      <h3 class="text-danger fw-bold">{{ worst_form }}</h3>
    </div>
  </div>
</div>

<hr>
<h4 class="text-secondary mt-4">Biometrikus adatok trendje (14 nap)</h4>
<canvas id="biometricChart" height="120"></canvas>

<h4 class="text-secondary mt-4">Edz√©sintenzit√°s trend</h4>
<canvas id="intensityChart" height="100"></canvas>

<h4 class="text-secondary mt-5">Formaindex trend (aktu√°lis √©s v√°rhat√≥)</h4>
<canvas id="formTrendChart" height="120"></canvas>

<h4 class="text-secondary mt-5">S√©r√ºl√©skock√°zat trend</h4>
<canvas id="injuryChart" height="100"></canvas>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const chartData = {{ chart_data|safe }};

// Biometrikus grafikon
const ctx1 = document.getElementById('biometricChart').getContext('2d');
new Chart(ctx1, {
  type: 'line',
  data: {
    labels: chartData.dates,
    datasets: [
      { label: 'S√∫ly (kg)', data: chartData.weights, borderColor: 'blue', fill: false },
      { label: 'HRV (ms)', data: chartData.hrv, borderColor: 'green', fill: false },
      { label: 'Alv√°s min≈ës√©g', data: chartData.sleep_quality, borderColor: 'orange', fill: false },
    ]
  },
  options: { responsive: true }
});

// Intenzit√°s grafikon
const ctx2 = document.getElementById('intensityChart').getContext('2d');
new Chart(ctx2, {
  type: 'bar',
  data: {
    labels: chartData.dates,
    datasets: [
      { label: 'Edz√©sintenzit√°s', data: chartData.intensity, backgroundColor: 'red' }
    ]
  },
  options: { responsive: true }
});

// Formaindex trend
const ctx3 = document.getElementById('formTrendChart').getContext('2d');
new Chart(ctx3, {
  type: 'line',
  data: {
    labels: chartData.trend_dates,
    datasets: [
      {
        label: 'Formaindex',
        data: chartData.trend_values,
        borderColor: 'purple',
        fill: false,
        tension: 0.3,
        pointRadius: 4,
        pointBackgroundColor: 'purple'
      }
    ]
  },
  options: {
    responsive: true,
    scales: {
      y: {
        beginAtZero: true,
        suggestedMax: 100
      }
    }
  }
});

// s√©r√ºl√©s kock√°zat trend
const ctx4 = document.getElementById('injuryChart').getContext('2d');
new Chart(ctx4, {
  type: 'line',
  data: {
    labels: chartData.dates,
    datasets: [{
      label: 'S√©r√ºl√©skock√°zat (%)',
      data: chartData.injury_risk,
      borderColor: 'red',
      fill: false,
      tension: 0.3,
      pointRadius: 3,
      pointBackgroundColor: 'red'
    }]
  },
  options: { responsive: true }
});
</script>
{% endblock %}
